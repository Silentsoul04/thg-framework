<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="darkcode0x00 luizcorrea">
        <link rel="canonical" href="https://darkcode357.gitlab.io/thg-framework/dev/dark/How-to-use-Railgun-for-Windows-post-exploitation/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>How to use Railgun for Windows post exploitation - thg-framework</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">thg-framework</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../cli/install/">Installation</a>
</li>
                                    
<li >
    <a href="../../..">Introduction</a>
</li>
                                    
<li >
    <a href="../../../community/">Community</a>
</li>
                                    
<li >
    <a href="../../../conceptual/">Conceptual</a>
</li>
                                    
<li >
    <a href="../../../cli/build/">build</a>
</li>
                                    
<li >
    <a href="../../../cli/tags/">tags</a>
</li>
                                    
<li >
    <a href="../../../LICENSE/">LICENSE</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">thg_dev <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">gettin_started</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/_Sidebar/">thg_Development_Environment</a>
</li>
            
<li >
    <a href="../../thg_dev/Using-thg/">using_thg</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">git</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../git/Using-Git/">Using-Git</a>
</li>
            
<li >
    <a href="../../git/Git-cheatsheet/">Git_cheatsheet</a>
</li>
            
<li >
    <a href="../../git/Git-Reference-Sites/">Git-Reference-Sites</a>
</li>
    </ul>
  </li>
            
<li >
    <a href="../../thg_dev/Reporting-a-Bug/">reporting_a_bug</a>
</li>
            
<li >
    <a href="../../contributing/Contributing-to-thg/">Get Started</a>
</li>
            
<li >
    <a href="../../../cli/templates/">templates</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Roadmaps</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">2019</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap/">Roadmap</a>
</li>
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap-Review/">Roadmap_Review</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">contributing</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/Contributing-to-thg/">contributing_to_thg</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">thg_development</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/Style_Tips/">Style_Tips</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-get-started-with-writing-an-exploit/">How_to_get_started_with_writing_an_exploit</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">capture the flag</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">basic</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/analysis/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/malware/">malware</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">recovery</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/recover/backuo/">backup</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/recover/patching/">patching</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">tips_end_tricks</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/tools/">tools</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/decoding/">decoding</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/dos/">dos</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/os_cheats/">os_cheats</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/snort/">snort</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/identify/basic/">basic</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nmap/">nmap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nessus/">nessus</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/openvas/">openvas</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">defend</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/tcpdump/">tcpdump</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/editcap/">edicap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/mergecap/">mergecap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/snort/">snort</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/tshark/">tshark</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/analysis/">analysis</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">os</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/windows/">windows</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
<li >
    <a href="../../../deployment/">Deployment</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">hash_crack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/hash_crack/">index</a>
</li>
            
<li >
    <a href="../../../capturetheflag/hash_crack/CORE_HASH_CRACKING_KNOWLEDGE/">CORE_HASH_CRACKING_KNOWLEDGE</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">pentest_standard</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../pentest_standard/preengagemente/">Pre engagement Interactions</a>
</li>
            
<li >
    <a href="../../../pentest_standard/ig/">Intelligence Gathering</a>
</li>
            
<li >
    <a href="../../../pentest_standard/threatmodeling/">Threat Modeling</a>
</li>
            
<li >
    <a href="../../../pentest_standard/vulnterability/">Vulnerability Analysis</a>
</li>
            
<li >
    <a href="../../../pentest_standard/exploration/">Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/postexploration/">Post Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/report/">Reporting</a>
</li>
            
<li >
    <a href="../../../pentest_standard/tecguidelines/">Technical Guidelines</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">CLI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-1</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/thg/">THG</a>
</li>
            
<li >
    <a href="../../../tutorials/server/server/">thg_server</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/shells/shells/">thg_shells</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_docs/thg_docs/">thg_docs</a>
</li>
            
<li >
    <a href="../../../tutorials/auxiliares/auxiliares/">thg_auxiliares</a>
</li>
            
<li >
    <a href="../../../tutorials/anti_forensic/anti_forensic/">thg_anti_forensic</a>
</li>
            
<li >
    <a href="../../../tutorials/crypto/crypto/">thg_crypto</a>
</li>
            
<li >
    <a href="../../../tutorials/drone/drone/">thg_drone</a>
</li>
            
<li >
    <a href="../../../tutorials/keylogger/keylogger/">thg_keylogger</a>
</li>
            
<li >
    <a href="../../../tutorials/recon/recon/">thg_recon</a>
</li>
            
<li >
    <a href="../../../tutorials/voip/voip/">thg_voip</a>
</li>
            
<li >
    <a href="../../../tutorials/automation/automation/">thg_automation</a>
</li>
            
<li >
    <a href="../../../tutorials/cryptography/cryptography/">thg_cryptography</a>
</li>
            
<li >
    <a href="../../../tutorials/exploitation/exploitation/">thg_exploitation</a>
</li>
            
<li >
    <a href="../../../tutorials/malware/malware/">thg_malware</a>
</li>
            
<li >
    <a href="../../../tutorials/reversing/reversing/">thg_reversing</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_windows/thg_windows/">thg_windows</a>
</li>
            
<li >
    <a href="../../../tutorials/automobile/automobile/">thg_automobile</a>
</li>
            
<li >
    <a href="../../../tutorials/database/database/">thg_database</a>
</li>
            
<li >
    <a href="../../../tutorials/fingerprint/fingerprint/">thg_fingerprint</a>
</li>
            
<li >
    <a href="../../../tutorials/misc/misc/">thg_misc</a>
</li>
            
<li >
    <a href="../../../tutorials/sniffer/sniffer/">thg_sniffer</a>
</li>
            
<li >
    <a href="../../../tutorials/wireless/wireless/">thg_wireless</a>
</li>
            
<li >
    <a href="../../../tutorials/debugger/debugger/">thg_debugger</a>
</li>
            
<li >
    <a href="../../../tutorials/firmware/firmware/">thg_firmware</a>
</li>
            
<li >
    <a href="../../../tutorials/mobile/mobile/">thg_mobile</a>
</li>
            
<li >
    <a href="../../../tutorials/social/social/">thg_social</a>
</li>
            
<li >
    <a href="../../../tutorials/backdoor/backdoor/">thg_backdoor</a>
</li>
            
<li >
    <a href="../../../tutorials/decompiler/decompiler/">thg_decompiler</a>
</li>
            
<li >
    <a href="../../../tutorials/forensic/forensic/">thg_forensic</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-2</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/networking/networking/">thg_networking</a>
</li>
            
<li >
    <a href="../../../tutorials/spoff/spoff/">thg_spoff</a>
</li>
            
<li >
    <a href="../../../tutorials/binary/binary/">thg_binary</a>
</li>
            
<li >
    <a href="../../../tutorials/defensensive/defensensive/">thg_defensensive</a>
</li>
            
<li >
    <a href="../../../tutorials/gpu/gpu/">thg_gpu</a>
</li>
            
<li >
    <a href="../../../tutorials/os/os/">thg_os</a>
</li>
            
<li >
    <a href="../../../tutorials/nfc/nfc/">thg_nfc</a>
</li>
            
<li >
    <a href="../../../tutorials/spoof/spoof/">thg_spoof</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/bluetooth/bluetooth/">thg_bluetooth</a>
</li>
            
<li >
    <a href="../../../tutorials/defensive/defensive/">thg_defensive</a>
</li>
            
<li >
    <a href="../../../tutorials/hardware/hardware/">thg_hardware</a>
</li>
            
<li >
    <a href="../../../tutorials/packer/packer/">thg_packer</a>
</li>
            
<li >
    <a href="../../../tutorials/stego/stego/">thg_stego</a>
</li>
            
<li >
    <a href="../../../tutorials/code_audit/code_audit/">thg_code_audit</a>
</li>
            
<li >
    <a href="../../../tutorials/disassembler/disassembler/">thg_disassembler</a>
</li>
            
<li >
    <a href="../../../tutorials/honeypot/honeypot/">thg_honeypot</a>
</li>
            
<li >
    <a href="../../../tutorials/proxy/proxy/">thg_proxy</a>
</li>
            
<li >
    <a href="../../../tutorials/tunnel/tunnel/">thg_tunnel</a>
</li>
            
<li >
    <a href="../../../tutorials/cracker/cracker/">thg_cracker</a>
</li>
            
<li >
    <a href="../../../tutorials/dos/dos/">thg_dos</a>
</li>
            
<li >
    <a href="../../../tutorials/ids/ids/">thg_ids</a>
</li>
            
<li >
    <a href="../../../tutorials/radio/radio/">thg_radio</a>
</li>
            
<li >
    <a href="../../../tutorials/unpacker/unpacker/">thg_unpacker</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li>
                                <a href="https://gitlab.com/darkcode357/thg-framework/edit/master/docs/dev/dark/How-to-use-Railgun-for-Windows-post-exploitation.md">Edit on darkcode357/thg-framework</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#defining-a-dll-and-its-functions">Defining a DLL and its functions</a></li>
        <li class="main "><a href="#usage">Usage</a></li>
        <li class="main "><a href="#memory-reading-and-writing">Memory Reading and Writing</a></li>
        <li class="main "><a href="#references">References:</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p>Railgun is a very powerful post exploitation feature exclusive to Windows Meterpreter. It allows you to have complete control of your target machine's Windows API, or you can use whatever DLL you find and do even more creative stuff with it. For example: say you have a meterpreter session on a Windows target. You have your eyes on a particular application that you believe stores the user's password, but it is encrypted and there are no tools out there for decryption. With Railgun, what you can do is you can either tap into the process and grep for any sensitive information found in memory, or you can look for the program's DLL that's responsible for the decryption, call it, and let it decrypt it for you. If you're a penetration tester, obviously post exploitation is an important skill to have, but if you don't know Railgun, you are missing out a lot.</p>
<h3 id="defining-a-dll-and-its-functions">Defining a DLL and its functions</h3>
<p>The Windows API is obviously quite large, so by default Railgun only comes with a handful of pre-defined DLLs and functions that are commonly used for building a Windows program. These built-in DLLs are: kernel32, ntdll, user32, ws2_32, iphlpapi, advapi32, shell32, netapi32, crypt32, wlanapi, wldap32, version. The same list of built-in DLLs can also be retrieved by using the <code>known_dll_names</code> method.</p>
<p>All DLL definitions are found in the "<a href="https://github.com/rapid7/metasploit-framework/tree/master/lib/rex/post/meterpreter/extensions/stdapi/railgun/def">def</a>" directory, where they are defined as classes. The following template should demonstrate how a DLL is actually defined:</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: binary -*-</span>
<span class="k">module</span> <span class="nn">Rex</span>
<span class="k">module</span> <span class="nn">Post</span>
<span class="k">module</span> <span class="nn">Meterpreter</span>
<span class="k">module</span> <span class="nn">Extensions</span>
<span class="k">module</span> <span class="nn">Stdapi</span>
<span class="k">module</span> <span class="nn">Railgun</span>
<span class="k">module</span> <span class="nn">Def</span>

<span class="k">class</span> <span class="nc">Def_somedll</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_dll</span><span class="p">(</span><span class="n">dll_path</span> <span class="o">=</span> <span class="s1">&#39;somedll&#39;</span><span class="p">)</span>
    <span class="n">dll</span> <span class="o">=</span> <span class="no">DLL</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dll_path</span><span class="p">,</span> <span class="no">ApiConstants</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

    <span class="c1"># 1st argument = Name of the function</span>
    <span class="c1"># 2nd argument = Return value&#39;s data type</span>
    <span class="c1"># 3rd argument = An array of parameters</span>
    <span class="n">dll</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="s1">&#39;SomeFunction&#39;</span><span class="p">,</span> <span class="s1">&#39;DWORD&#39;</span><span class="p">,</span><span class="o">[</span>
      <span class="o">[</span><span class="s2">&quot;DWORD&quot;</span><span class="p">,</span><span class="s2">&quot;hwnd&quot;</span><span class="p">,</span><span class="s2">&quot;in&quot;</span><span class="o">]</span>
    <span class="o">]</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dll</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="k">end</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">end</span>
</pre></div>

<p>In function definitions, Railgun supports these datatypes: VOID, BOOL, DWORD, WORD, BYTE, LPVOID, HANDLE, PDWORD, PWCHAR, PCHAR, PBLOB.</p>
<p>There are four parameter/buffer directions: in, out, inout, and return. When you pass a value to an "in" parameter, Railgun handles the memory management. For example, <code>MessageBoxA</code> has a "in" parameter named <code>lpText</code>, and is of type PCHAR. You can simply pass a Ruby string to it, and Railgun handles the rest, it's all pretty straight forward.</p>
<p>An "out" parameter will always be of a pointer datatype. Basically you tell Railgun how many bytes to allocate for the parameter, it allocates memory, provides a pointer to it when calling the function, and then it reads that region of memory that the function wrote, converts that to a Ruby object and adds it to the return hash.</p>
<p>An "inout" parameter serves as an input to the called function, but can be potentially modified by it. You can inspect the return hash for the modified value like an "out" parameter.</p>
<p>A quick way to define a new function at runtime can be done like the following example:</p>
<div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">railgun</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="s1">&#39;user32&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageBoxA&#39;</span><span class="p">,</span> <span class="s1">&#39;DWORD&#39;</span><span class="p">,</span><span class="o">[</span>
    <span class="o">[</span><span class="s2">&quot;DWORD&quot;</span><span class="p">,</span><span class="s2">&quot;hWnd&quot;</span><span class="p">,</span><span class="s2">&quot;in&quot;</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s2">&quot;PCHAR&quot;</span><span class="p">,</span><span class="s2">&quot;lpText&quot;</span><span class="p">,</span><span class="s2">&quot;in&quot;</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s2">&quot;PCHAR&quot;</span><span class="p">,</span><span class="s2">&quot;lpCaption&quot;</span><span class="p">,</span><span class="s2">&quot;in&quot;</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s2">&quot;DWORD&quot;</span><span class="p">,</span><span class="s2">&quot;uType&quot;</span><span class="p">,</span><span class="s2">&quot;in&quot;</span><span class="o">]</span>
 <span class="o">]</span><span class="p">)</span>
</pre></div>

<p>However, if this function will most likely be used more than once, or it's part of the Windows API, then you should put it in the library.</p>
<h3 id="usage">Usage</h3>
<p>The best way to try Railgun is with irb in a Windows Meterpreter prompt. Here's an example of how to get there:</p>
<div class="highlight"><pre><span></span>$ msfconsole -q
msf &gt; use exploit/multi/handler 
msf exploit(handler) &gt; run

[*] Started reverse handler on 192.168.1.64:4444 
[*] Starting the payload handler...
[*] Sending stage (769536 bytes) to 192.168.1.106
[*] Meterpreter session 1 opened (192.168.1.64:4444 -&gt; 192.168.1.106:55148) at 2014-07-30 19:49:35 -0500

meterpreter &gt; irb
[*] Starting IRB shell
[*] The &#39;client&#39; variable holds the meterpreter client

&gt;&gt;
</pre></div>

<p>Note that when you're running a post module or in irb, you always have a <code>client</code> or <code>session</code> object to work with, both point to same thing, which in this case is <code>Msf::Sessions::Meterpreter_x86_Win</code>. This Meterpreter session object gives you API access to the target machine, including the Railgun object <code>Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::Railgun</code>. Here's how you simply access it:</p>
<div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">railgun</span>
</pre></div>

<p>If you run the above in irb, you will see that it returns information about all the DLLs, functions, constants, etc, except it's a little unfriendly to read because there's so much data. Fortunately, there are some handy tricks to help us to figure things out. For example, like we mentioned before, if you're not sure what DLLs are loaded, you can call the <code>known_dll_names</code> method:</p>
<div class="highlight"><pre><span></span>&gt;&gt; session.railgun.known_dll_names
=&gt; [&quot;kernel32&quot;, &quot;ntdll&quot;, &quot;user32&quot;, &quot;ws2_32&quot;, &quot;iphlpapi&quot;, &quot;advapi32&quot;, &quot;shell32&quot;, &quot;netapi32&quot;, &quot;crypt32&quot;, &quot;wlanapi&quot;, &quot;wldap32&quot;, &quot;version&quot;]
</pre></div>

<p>Now, say we're interested in user32 and we want to find all the available functions (as well as return value's data type, parameters), another handy trick is this:</p>
<div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">railgun</span><span class="o">.</span><span class="n">user32</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">each_pair</span> <span class="p">{</span><span class="o">|</span><span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;Function name: </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">, Returns: </span><span class="si">#{</span><span class="n">v</span><span class="o">.</span><span class="n">return_type</span><span class="si">}</span><span class="s2">, Params: </span><span class="si">#{</span><span class="n">v</span><span class="o">.</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</pre></div>

<p>Note that if you happen to call an invalid or unsupported Windows function, a <code>RuntimeError</code> will raise, and the error message also shows a list of available functions.</p>
<p>To call a Windows API function, here's how:</p>
<div class="highlight"><pre><span></span>&gt;&gt; session.railgun.user32.MessageBoxA(0, &quot;hello, world&quot;, &quot;hello&quot;, &quot;MB_OK&quot;)
=&gt; {&quot;GetLastError&quot;=&gt;0, &quot;ErrorMessage&quot;=&gt;&quot;The operation completed successfully.&quot;, &quot;return&quot;=&gt;1}
</pre></div>

<p>As you can see this API call returns a hash. One habit we have seen is that sometimes people don't like to check <code>GetLastError</code>, <code>ErrorMessage</code>, and/or the <code>return</code> value, they kind of just assume it works. This is a bad programming habit, and is not recommended. If you always assume something works, and execute the next API call, you risk having unexpected results (worst case scenario: losing the Meterpreter session).</p>
<h3 id="memory-reading-and-writing">Memory Reading and Writing</h3>
<p>The <code>Railgun</code> class also has two very useful methods that you will probably use: <code>memread</code> and <code>memwrite</code>. The names are pretty self-explanatory: You read a block of memory, or you write to a region of memory. We'll demonstrate this with a new block of memory in the payload itself:</p>
<div class="highlight"><pre><span></span>&gt;&gt; p = session.sys.process.open(session.sys.process.getpid, PROCESS_ALL_ACCESS)
=&gt; #&lt;#&lt;Class:0x007fe2e051b740&gt;:0x007fe2c5a258a0 @client=#&lt;Session:meterpreter 192.168.1.106:55151 (192.168.1.106) &quot;WIN-6NH0Q8CJQVM\sinn3r @ WIN-6NH0Q8CJQVM&quot;&gt;, @handle=448, @channel=nil, @pid=2268, @aliases={&quot;image&quot;=&gt;#&lt;Rex::Post::Meterpreter::Extensions::Stdapi::Sys::ProcessSubsystem::Image:0x007fe2c5a25828 @process=#&lt;#&lt;Class:0x007fe2e051b740&gt;:0x007fe2c5a258a0 ...&gt;&gt;, &quot;io&quot;=&gt;#&lt;Rex::Post::Meterpreter::Extensions::Stdapi::Sys::ProcessSubsystem::IO:0x007fe2c5a257b0 @process=#&lt;#&lt;Class:0x007fe2e051b740&gt;:0x007fe2c5a258a0 ...&gt;&gt;, &quot;memory&quot;=&gt;#&lt;Rex::Post::Meterpreter::Extensions::Stdapi::Sys::ProcessSubsystem::Memory:0x007fe2c5a25738 @process=#&lt;#&lt;Class:0x007fe2e051b740&gt;:0x007fe2c5a258a0 ...&gt;&gt;, &quot;thread&quot;=&gt;#&lt;Rex::Post::Meterpreter::Extensions::Stdapi::Sys::ProcessSubsystem::Thread:0x007fe2c5a256c0 @process=#&lt;#&lt;Class:0x007fe2e051b740&gt;:0x007fe2c5a258a0 ...&gt;&gt;}&gt;
&gt;&gt; p.memory.allocate(1024)
=&gt; 5898240
</pre></div>

<p>As you can see, the new allocation is at address 5898240 (or 0x005A0000 in hex). Let's first write four bytes to it:</p>
<div class="highlight"><pre><span></span>&gt;&gt; session.railgun.memwrite(5898240, &quot;AAAA&quot;, 4)
=&gt; true
</pre></div>

<p><code>memwrite</code> returns true, which means successful. Now let's read 4 bytes from 0x005A0000:</p>
<div class="highlight"><pre><span></span>&gt;&gt; session.railgun.memread(5898240, 4)
=&gt; &quot;AAAA&quot;
</pre></div>

<p>Be aware that if you supply a bad pointer, you can cause an access violation and crash Meterpreter.</p>
<h3 id="references">References:</h3>
<p><a href="https://www.youtube.com/watch?v=AniR-T0AnnI">https://www.youtube.com/watch?v=AniR-T0AnnI</a></p>
<p><a href="https://www.defcon.org/images/defcon-20/dc-20-presentations/Maloney/DEFCON-20-Maloney-Railgun.pdf">https://www.defcon.org/images/defcon-20/dc-20-presentations/Maloney/DEFCON-20-Maloney-Railgun.pdf</a></p>
<p><a href="https://dev.metasploit.com/redmine/projects/framework/wiki/RailgunUsage">https://dev.metasploit.com/redmine/projects/framework/wiki/RailgunUsage</a></p>
<p><a href="https://github.com/rapid7/metasploit-framework/tree/master/lib/rex/post/meterpreter/extensions/stdapi/railgun">https://github.com/rapid7/metasploit-framework/tree/master/lib/rex/post/meterpreter/extensions/stdapi/railgun</a></p>
<p><a href="http://msdn.microsoft.com/en-us/library/ms681381(VS.85).aspx">http://msdn.microsoft.com/en-us/library/ms681381(VS.85).aspx</a></p>
<p><a href="http://msdn.microsoft.com/en-us/library/aa383749">http://msdn.microsoft.com/en-us/library/aa383749</a></p>
<p><a href="http://undocumented.ntinternals.net/">http://undocumented.ntinternals.net/</a></p>
<p><a href="http://source.winehq.org/WineAPI/">http://source.winehq.org/WineAPI/</a></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2019 - 2020 darkcode0x00</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
