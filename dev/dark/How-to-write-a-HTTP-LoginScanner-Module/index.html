<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="darkcode0x00 luizcorrea">
        <link rel="canonical" href="https://darkcode357.github.io/thg-framework/dev/dark/How-to-write-a-HTTP-LoginScanner-Module/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>How to write a HTTP LoginScanner Module - thg-framework</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">thg-framework</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../cli/install/">Installation</a>
</li>
                                    
<li >
    <a href="../../..">Introduction</a>
</li>
                                    
<li >
    <a href="../../../community/">Community</a>
</li>
                                    
<li >
    <a href="../../../conceptual/">Conceptual</a>
</li>
                                    
<li >
    <a href="../../../cli/build/">build</a>
</li>
                                    
<li >
    <a href="../../../cli/tags/">tags</a>
</li>
                                    
<li >
    <a href="../../../LICENSE/">LICENSE</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">thg_dev <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../thg_dev/_Sidebar/">thg_dev</a>
</li>
                                    
<li >
    <a href="../../contributing/Contributing-to-thg/">Get Started</a>
</li>
                                    
<li >
    <a href="../../../cli/templates/">templates</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Roadmaps</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">2019</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap/">Roadmap</a>
</li>
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap-Review/">Roadmap_Review</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">git</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../git/Using-Git/">Using-Git</a>
</li>
            
<li >
    <a href="../../git/Git-cheatsheet/">Git_cheatsheet</a>
</li>
            
<li >
    <a href="../../git/Git-Reference-Sites/">Git-Reference-Sites</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">capture the flag</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">basic</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/analysis/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/malware/">malware</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">recovery</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/recover/backuo/">backup</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/recover/patching/">patching</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">tips_end_tricks</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/tools/">tools</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/decoding/">decoding</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/dos/">dos</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/os_cheats/">os_cheats</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/snort/">snort</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/identify/basic/">basic</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nmap/">nmap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nessus/">nessus</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/openvas/">openvas</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">defend</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/tcpdump/">tcpdump</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/editcap/">edicap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/mergecap/">mergecap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/snort/">snort</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/tshark/">tshark</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/analysis/">analysis</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">os</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/windows/">windows</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
<li >
    <a href="../../../deployment/">Deployment</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">hash_crack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/hash_crack/">index</a>
</li>
            
<li >
    <a href="../../../capturetheflag/hash_crack/CORE_HASH_CRACKING_KNOWLEDGE/">CORE_HASH_CRACKING_KNOWLEDGE</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">pentest_standard</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../pentest_standard/preengagemente/">Pre engagement Interactions</a>
</li>
            
<li >
    <a href="../../../pentest_standard/ig/">Intelligence Gathering</a>
</li>
            
<li >
    <a href="../../../pentest_standard/threatmodeling/">Threat Modeling</a>
</li>
            
<li >
    <a href="../../../pentest_standard/vulnterability/">Vulnerability Analysis</a>
</li>
            
<li >
    <a href="../../../pentest_standard/exploration/">Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/postexploration/">Post Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/report/">Reporting</a>
</li>
            
<li >
    <a href="../../../pentest_standard/tecguidelines/">Technical Guidelines</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">CLI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-1</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/thg/">THG</a>
</li>
            
<li >
    <a href="../../../tutorials/server/server/">thg_server</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/shells/shells/">thg_shells</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_docs/thg_docs/">thg_docs</a>
</li>
            
<li >
    <a href="../../../tutorials/auxiliares/auxiliares/">thg_auxiliares</a>
</li>
            
<li >
    <a href="../../../tutorials/anti_forensic/anti_forensic/">thg_anti_forensic</a>
</li>
            
<li >
    <a href="../../../tutorials/crypto/crypto/">thg_crypto</a>
</li>
            
<li >
    <a href="../../../tutorials/drone/drone/">thg_drone</a>
</li>
            
<li >
    <a href="../../../tutorials/keylogger/keylogger/">thg_keylogger</a>
</li>
            
<li >
    <a href="../../../tutorials/recon/recon/">thg_recon</a>
</li>
            
<li >
    <a href="../../../tutorials/voip/voip/">thg_voip</a>
</li>
            
<li >
    <a href="../../../tutorials/automation/automation/">thg_automation</a>
</li>
            
<li >
    <a href="../../../tutorials/cryptography/cryptography/">thg_cryptography</a>
</li>
            
<li >
    <a href="../../../tutorials/exploitation/exploitation/">thg_exploitation</a>
</li>
            
<li >
    <a href="../../../tutorials/malware/malware/">thg_malware</a>
</li>
            
<li >
    <a href="../../../tutorials/reversing/reversing/">thg_reversing</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_windows/thg_windows/">thg_windows</a>
</li>
            
<li >
    <a href="../../../tutorials/automobile/automobile/">thg_automobile</a>
</li>
            
<li >
    <a href="../../../tutorials/database/database/">thg_database</a>
</li>
            
<li >
    <a href="../../../tutorials/fingerprint/fingerprint/">thg_fingerprint</a>
</li>
            
<li >
    <a href="../../../tutorials/misc/misc/">thg_misc</a>
</li>
            
<li >
    <a href="../../../tutorials/sniffer/sniffer/">thg_sniffer</a>
</li>
            
<li >
    <a href="../../../tutorials/wireless/wireless/">thg_wireless</a>
</li>
            
<li >
    <a href="../../../tutorials/debugger/debugger/">thg_debugger</a>
</li>
            
<li >
    <a href="../../../tutorials/firmware/firmware/">thg_firmware</a>
</li>
            
<li >
    <a href="../../../tutorials/mobile/mobile/">thg_mobile</a>
</li>
            
<li >
    <a href="../../../tutorials/social/social/">thg_social</a>
</li>
            
<li >
    <a href="../../../tutorials/backdoor/backdoor/">thg_backdoor</a>
</li>
            
<li >
    <a href="../../../tutorials/decompiler/decompiler/">thg_decompiler</a>
</li>
            
<li >
    <a href="../../../tutorials/forensic/forensic/">thg_forensic</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-2</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/networking/networking/">thg_networking</a>
</li>
            
<li >
    <a href="../../../tutorials/spoff/spoff/">thg_spoff</a>
</li>
            
<li >
    <a href="../../../tutorials/binary/binary/">thg_binary</a>
</li>
            
<li >
    <a href="../../../tutorials/defensensive/defensensive/">thg_defensensive</a>
</li>
            
<li >
    <a href="../../../tutorials/gpu/gpu/">thg_gpu</a>
</li>
            
<li >
    <a href="../../../tutorials/os/os/">thg_os</a>
</li>
            
<li >
    <a href="../../../tutorials/nfc/nfc/">thg_nfc</a>
</li>
            
<li >
    <a href="../../../tutorials/spoof/spoof/">thg_spoof</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/bluetooth/bluetooth/">thg_bluetooth</a>
</li>
            
<li >
    <a href="../../../tutorials/defensive/defensive/">thg_defensive</a>
</li>
            
<li >
    <a href="../../../tutorials/hardware/hardware/">thg_hardware</a>
</li>
            
<li >
    <a href="../../../tutorials/packer/packer/">thg_packer</a>
</li>
            
<li >
    <a href="../../../tutorials/stego/stego/">thg_stego</a>
</li>
            
<li >
    <a href="../../../tutorials/code_audit/code_audit/">thg_code_audit</a>
</li>
            
<li >
    <a href="../../../tutorials/disassembler/disassembler/">thg_disassembler</a>
</li>
            
<li >
    <a href="../../../tutorials/honeypot/honeypot/">thg_honeypot</a>
</li>
            
<li >
    <a href="../../../tutorials/proxy/proxy/">thg_proxy</a>
</li>
            
<li >
    <a href="../../../tutorials/tunnel/tunnel/">thg_tunnel</a>
</li>
            
<li >
    <a href="../../../tutorials/cracker/cracker/">thg_cracker</a>
</li>
            
<li >
    <a href="../../../tutorials/dos/dos/">thg_dos</a>
</li>
            
<li >
    <a href="../../../tutorials/ids/ids/">thg_ids</a>
</li>
            
<li >
    <a href="../../../tutorials/radio/radio/">thg_radio</a>
</li>
            
<li >
    <a href="../../../tutorials/unpacker/unpacker/">thg_unpacker</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li>
                                <a href="https://github.com/darkcode357/thg-framework/edit/master/docs/dev/dark/How-to-write-a-HTTP-LoginScanner-Module.md">Edit on darkcode357/thg-framework</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#step-1-set-up-your-target-environment">Step 1: Set up your target environment</a></li>
        <li class="main "><a href="#step-2-set-up-a-client">Step 2: Set up a client</a></li>
        <li class="main "><a href="#step-3-start-with-a-loginscanner-template">Step 3: Start with a LoginScanner template</a></li>
        <li class="main "><a href="#step-4-write-the-auxiliary-module">Step 4: Write the auxiliary module</a></li>
        <li class="main "><a href="#test">Test</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p>This is a step-by-step guide on how to write a HTTP login module using the latest LoginScanner and Credential APIs.</p>
<p>Before we begin, it&rsquo;s probably a good idea to read <a href="https://github.com/rapid7/metasploit-framework/wiki/Creating-Metasploit-Framework-LoginScanners">Creating Metasploit Framework LoginScanners</a>, which explains about the APIs in-depth. The LoginScanner API can be found in the <a href="https://github.com/rapid7/metasploit-framework/tree/master/lib/metasploit/framework/login_scanner">lib/metasploit/framework/loginscanner</a> directory, and the Credential API can found as a <a href="https://github.com/rapid7/metasploit-credential">metasploit-credential gem here</a>. You will most likely want to read them while writing the login module.</p>
<h2 id="step-1-set-up-your-target-environment">Step 1: Set up your target environment<a class="headerlink" href="#step-1-set-up-your-target-environment" title="Permanent link">&para;</a></h2>
<p>For our demonstration, we will be using <a href="http://www.symantec.com/web-gateway/">Symantec Web Gateway</a>. A trial is available at the vendor&rsquo;s website. Obviously downloading/installing it would be your first step.</p>
<h2 id="step-2-set-up-a-client">Step 2: Set up a client<a class="headerlink" href="#step-2-set-up-a-client" title="Permanent link">&para;</a></h2>
<p>The purpose of setting up a client is to sample the login request and response. Normally you can do this with:</p>
<ul>
<li><strong>A web browser plus a sniffer</strong></li>
</ul>
<ol>
<li>For the sniffer, you can download <a href="https://www.wireshark.org/download.html">Wireshark</a>, and have it running.</li>
<li>Use a web browser to login.</li>
<li>Go back to Wireshark and save the HTTP request, this is exactly what you will send in the login module. You will also need to save the HTTP response so that you can check for a successful and a failed login.</li>
</ol>
<ul>
<li><strong>A browser with Burp</strong></li>
</ul>
<p><a href="http://portswigger.net/burp/download.html">Burp</a> is a tool for performing security testing of web applications. You can download the free version from the vendor&rsquo;s website. In some cases, Burp is way better than a sniffer because you can modify HTTP requests, it&rsquo;s also a very convenient way to capture HTTPS traffic.</p>
<p>Here&rsquo;s what you do.</p>
<ol>
<li>Start Burp.</li>
<li>Configure your web browser&rsquo;s proxy so Burp can forward traffic.</li>
<li>Use the web browser to login.</li>
<li>Go back to Burp, you can find the history of all the requests and responses.</li>
</ol>
<p>For our example, this is the request the browser sends to Symantec Web Gateway:</p>
<pre><code>POST /spywall/login.php HTTP/1.1
Host: 192.168.1.176
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:27.0) Gecko/20100101 Firefox/27.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://192.168.1.176/spywall/login.php
Cookie: PHPSESSID=otgam4mgjrl00h2esk3o2npt05
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 54

USERNAME=gooduser&amp;PASSWORD=GoodPassword&amp;loginBtn=Login
</code></pre>

<p>And this is the response Symantec Web Gateway returns for a successful login:</p>
<pre><code>HTTP/1.1 302 Found
Date: Tue, 12 May 2015 19:32:31 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Set-Cookie: PHPSESSID=vmb56vhd7740oqcmth8cqtagq5; path=/; secure; HttpOnly
Location: https://192.168.1.176/spywall/executive_summary.php
Content-Length: 0
Keep-Alive: timeout=15, max=5000
Connection: Keep-Alive
Content-Type: text/html; charset=UTF-8
</code></pre>

<p>A failed login response is an HTTP 200 with the following message in the body:</p>
<pre><code>We're sorry, but the username or password you have entered is incorrect.  Please retype your username and password. The username and password are case sensitive.
</code></pre>

<h2 id="step-3-start-with-a-loginscanner-template">Step 3: Start with a LoginScanner template<a class="headerlink" href="#step-3-start-with-a-loginscanner-template" title="Permanent link">&para;</a></h2>
<p>Your login module mainly consists of three components: the LoginScanner portion, the auxiliary portion, and rpsec. The actual HTTP requests and responses are handled in the LoginScanner portion, so we&rsquo;ll start from there.</p>
<p>Your most basic HTTP LoginScanner template will look like this:</p>
<pre><code class="ruby">require 'metasploit/framework/login_scanner/http'

module Metasploit
  module Framework
    module LoginScanner
      class SymantecWebGateway &lt; HTTP


        # Attemps to login to the server.
        #
        # @param [Metasploit::Framework::Credential] credential The credential information.
        # @return [Result] A Result object indicating success or failure
        def attempt_login(credential)

        end

      end
    end
  end
end
</code></pre>

<p>Save it under lib/metasploit/framework/login_scanner/.</p>
<p><strong>The #attempt_login method</strong></p>
<p>The #attempt_login is called automatically. You can write your entire login code there, but it&rsquo;s better to break in down into multiple methods so that the code is cleaner, and easier to document and rspec. Typically, all you want #attempt_login to do is focusing on crafting the Result object, pass it to a custom #login routine, and then return the Result object. It almost always looks something like this:</p>
<pre><code class="ruby">def attempt_login(credential)
  # Default Result
  result_opts = {
    credential: credential,
    status: Metasploit::Model::Login::Status::INCORRECT,
    proof: nil,
    host: host,
    port: port,
    protocol: 'tcp'
  }

  # Merge login result
  # credential.public is the username
  # credential.private is the password
  result_opts.merge!(do_login(credential.public, credential.private))

  # Return the Result object
  Result.new(result_opts)
end
</code></pre>

<p>Notice that:</p>
<ul>
<li>By default, our proof is nil.</li>
<li>The status is Metasploit::Model::Login::Status::INCORRECT.</li>
<li>We&rsquo;re calling #do_login, which is our custom login method.</li>
<li>The #do_login method will have to update status and proof before we return the Result object.</li>
</ul>
<p><strong>The custom login method</strong></p>
<p>Ok, now let&rsquo;s talk about building this #do_login method. This is where we send the same HTTP request we sampled earlier.</p>
<p>If you&rsquo;re already familiar with writing a Metasploit module that sends an HTTP request, the first thing that comes to mind is probably using the <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-Send-an-HTTP-Request-Using-HTTPClient">HttpClient</a>. Well, you can&rsquo;t do that at all over here, so we have to fall back to <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-send-an-HTTP-request-using-Rex%3A%3AProto%3A%3AHttp%3A%3AClient">Rex::Proto::Http::Client</a>. Fortunately for you, we made all this a little bit easier by creating another request called #send_request, here&rsquo;s an example of how to use that:</p>
<pre><code class="ruby">send_request({'uri'=&gt;'/'})
</code></pre>

<p>You will rely on this method a lot to accomplish most of what you need to do here.</p>
<p>Ok, now, let&rsquo;s move on and talk about how to use #send_request to send a login request. Remember in the login request, there is actually a PHPSESSID cookie, you should obtain this first. Usually the web application will give you the session cookie when you request the login page for the very first time, and this happens a lot.</p>
<p>Here&rsquo;s an example of how to grab PHPSESSID:</p>
<pre><code class="ruby">def get_session_id
  login_uri = normalize_uri(&quot;#{uri}/spywall/login.php&quot;)
  res = send_request({'uri' =&gt; login_uri})
  sid = res.get_cookies.scan(/(PHPSESSID=\w+);*/).flatten[0] || ''
  return sid
end
</code></pre>

<p>Now that you have a session ID, you can finally make the login request. Remember in the sample, we have to submit the username, password, loginBtn as a POST request. So let&rsquo;s do that with #send_request:</p>
<pre><code class="ruby">protocol  = ssl ? 'https' : 'http'
peer      = &quot;#{host}:#{port}&quot;
login_uri = normalize_uri(&quot;#{uri}/spywall/login.php&quot;)

res = send_request({
  'uri' =&gt; login_uri,
  'method' =&gt; 'POST',
  'cookie' =&gt; get_session_id,
  'headers' =&gt; { 'Referer' =&gt; &quot;#{protocol}://#{peer}/#{login_uri}&quot; },
  'vars_post' =&gt; {
    'USERNAME' =&gt; username,
    'PASSWORD' =&gt; password,
    'loginBtn' =&gt; 'Login' # Found in the HTML form
  }
})
</code></pre>

<p>Now that the request is sent, we need to check the response (the res variable). Typically, you have a few choices to determine a successful login:</p>
<ul>
<li><strong>Check the HTTP response code</strong>. In this case, we have a 302 (redirect), but know that sometimes the response code can lie so this should not be your first choice.</li>
<li><strong>Check the HTML</strong>. With some web applications, you might get a &ldquo;successful login&rdquo; message, and you can regex that. This is most likely the most accurate way.</li>
<li><strong>Check the location header</strong>. In our case, Symantec returns a 302 and contains no body. But it redirects us to a spywall/executive_summary.php page in the location header, so we can use that. We can also try to access executive_summary.php with a renewed session ID, and make sure we can actually see the admin interface, but requesting an extra page adds more penalty to performance, so this is up to you.</li>
</ul>
<p>In the end, your custom login method will probably look something like this:</p>
<pre><code class="ruby">def do_login(username, password)
  protocol  = ssl ? 'https' : 'http'
  peer      = &quot;#{host}:#{port}&quot;
  login_uri = normalize_uri(&quot;#{uri}/spywall/login.php&quot;)

  res = send_request({
    'uri' =&gt; login_uri,
    'method' =&gt; 'POST',
    'cookie' =&gt; get_session_id,
    'headers' =&gt; {
      'Referer' =&gt; &quot;#{protocol}://#{peer}/#{login_uri}&quot;
    },
    'vars_post' =&gt; {
      'USERNAME' =&gt; username,
      'PASSWORD' =&gt; password,
      'loginBtn' =&gt; 'Login' # Found in the HTML form
    }
  })

  if res &amp;&amp; res.headers['Location'].include?('executive_summary.php')
    return {:status =&gt; LOGIN_STATUS::SUCCESSFUL, :proof =&gt; res.to_s}
  end

  {:proof =&gt; res.to_s}
end
</code></pre>

<p>The <a href="https://github.com/rapid7/metasploit-model/blob/d4c4f444c79937698dc703f89c0a4c576cde628c/lib/metasploit/model/login/status.rb">exact statuses</a> you can return are:</p>
<table>
<thead>
<tr>
<th>Constant</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Metasploit::Model::Login::Status::DENIED_ACCESS</td>
<td>Access is denied</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::DISABLED</td>
<td>Account is disabled</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::INCORRECT</td>
<td>Credential is incorrect</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::LOCKED_OUT</td>
<td>Account has been locked out</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::NO_AUTH_REQUIRED</td>
<td>No authentication</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::SUCCESSFUL</td>
<td>Successful login</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::UNABLE_TO_CONNECT</td>
<td>Unable to connect to the service</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::UNTRIED</td>
<td>Credential has not been tried</td>
</tr>
<tr>
<td>Metasploit::Model::Login::Status::ALL</td>
<td>All the above (An array)</td>
</tr>
</tbody>
</table>
<p>When you&rsquo;re done, your code will look something like this:</p>
<p>https://github.com/rapid7/metasploit-framework/blob/master/lib/metasploit/framework/login_scanner/symantec_web_gateway.rb</p>
<h2 id="step-4-write-the-auxiliary-module">Step 4: Write the auxiliary module<a class="headerlink" href="#step-4-write-the-auxiliary-module" title="Permanent link">&para;</a></h2>
<p>The auxiliary module acts more like an user-interface. You describe what the module does, handles options, initializes objects, and do reporting.</p>
<p>A basic auxiliary module template in our case would be something like this:</p>
<pre><code class="ruby">##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'
require 'metasploit/framework/login_scanner/symantec_web_gateway'
require 'metasploit/framework/credential_collection'

class MetasploitModule &lt; Msf::Auxiliary

  include Msf::Exploit::Remote::HttpClient
  include Msf::Auxiliary::AuthBrute
  include Msf::Auxiliary::Report
  include Msf::Auxiliary::Scanner

  def initialize(info={})
    super(update_info(info,
      'Name'        =&gt; 'Symantec Web Gateway Login Utility',
      'Description' =&gt; %q{
        This module will attempt to authenticate to a Symantec Web Gateway.
      },
      'Author'      =&gt; [ 'sinn3r' ],
      'License'     =&gt; MSF_LICENSE,
      'DefaultOptions' =&gt;
        {
          'RPORT'      =&gt; 443,
          'SSL'        =&gt; true,
          'SSLVersion' =&gt; 'TLS1'
        }
    ))
  end

  def run_host(ip)
  end

end
</code></pre>

<p>Save it under modules/auxiliary/scanner/http/.</p>
<p>Our main method is #run_host, so we&rsquo;ll begin there. But before we do, we must initialize your LoginScanner object. The following is an example of how you will probably write it.</p>
<pre><code class="ruby">def scanner(ip)
  @scanner ||= lambda {
    cred_collection = Metasploit::Framework::CredentialCollection.new(
      blank_passwords: datastore['BLANK_PASSWORDS'],
      pass_file:       datastore['PASS_FILE'],
      password:        datastore['PASSWORD'],
      user_file:       datastore['USER_FILE'],
      userpass_file:   datastore['USERPASS_FILE'],
      username:        datastore['USERNAME'],
      user_as_pass:    datastore['USER_AS_PASS']
    )

    return Metasploit::Framework::LoginScanner::SymantecWebGateway.new(
      configure_http_login_scanner(
        host: ip,
        port: datastore['RPORT'],
        cred_details:       cred_collection,
        stop_on_success:    datastore['STOP_ON_SUCCESS'],
        bruteforce_speed:   datastore['BRUTEFORCE_SPEED'],
        connection_timeout: 5
      ))
    }.call
end
</code></pre>

<p>Notice that this scanner method can be called multiple times, but the use of <a href="http://rubymonk.com/learning/books/1-ruby-primer/chapters/34-lambdas-and-blocks-in-ruby/lessons/77-lambdas-in-ruby">lambda</a> will allow the LoginScanner object to initialize only once. After that first time, every time the method is called, it will just return @scanner instead of going through the whole initialization process again.</p>
<p>In some cases you might need to pass more datastore options, maybe not. For example, if you want to allow the URI to be configurable (which is also already an accessor in <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/metasploit/framework/login_scanner/http.rb#L26">Metasploit::Framework::LoginScanner::HTTP</a>), then you have to create and pass datastore[&lsquo;URI&rsquo;] to configure_http_login_scanner too, like so:</p>
<pre><code class="ruby">uri: datastore['URI']
</code></pre>

<p>And then in your LoginScanner, pass <code>uri</code> to #send_request:</p>
<pre><code class="ruby">send_request({'uri'=&gt;uri})
</code></pre>

<p>At this point, the scanner method holds our Metasploit::Framework::LoginScanner::SymantecWebGateway object. If we call the #scan! method, it will trigger the #attempt_login method we wrote earlier, and then yield the Result object. Basically like this:</p>
<pre><code class="ruby">scanner(ip).scan! do |result|
  # result = Our Result object
end
</code></pre>

<p>With the Result object, we can start reporting. In most cases, you will probably be using #create_credential_login to report a successful login. And use #invalidate_login to report a bad one.</p>
<p><strong>Reporting a valid credential</strong></p>
<p>The credential API knows a lot about a credential, such as when it was used, how it was used, serviced tried, target IP, port, etc, etc. So when we report, that&rsquo;s how much information we are storing for every credential. To make credential reporting easy to use, all you need to do is call the #store_valid_credential method like this:</p>
<pre><code class="ruby">store_valid_credential(
  user: result.credential.public,
  private: result.credential.private,
  private_type: :password, # This is optional
  proof: nil, # This is optional
)
</code></pre>

<p><strong>Report an invalid credential</strong></p>
<p>Here&rsquo;s another example you can use:</p>
<pre><code class="ruby"># Reports a bad credential.
#
# @param [String] ip Target host
# @param [Fixnum] port Target port
# @param [Result] The Result object
# @return [void]
def report_bad_cred(ip, rport, result)
  invalidate_login(
    address: ip,
    port: rport,
    protocol: 'tcp',
    public: result.credential.public,
    private: result.credential.private,
    realm_key: result.credential.realm_key,
    realm_value: result.credential.realm,
    status: result.status,
    proof: result.proof
  )
end
</code></pre>

<p>At this point, you&rsquo;re pretty much done with the auxiliary module. It will probably look something like this:
https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/http/symantec_web_gateway_login.rb</p>
<h2 id="test">Test<a class="headerlink" href="#test" title="Permanent link">&para;</a></h2>
<p>And finally, make sure your module actually works.</p>
<p>Test for a successful login:</p>
<pre><code>msf auxiliary(symantec_web_gateway_login) &gt; run

[+] 192.168.1.176:443 SYMANTEC_WEB_GATEWAY - Success: 'sinn3r:GoodPassword'
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf auxiliary(symantec_web_gateway_login) &gt; 
</code></pre>

<p>Test for a failed login:</p>
<pre><code>msf auxiliary(symantec_web_gateway_login) &gt; run

[-] 192.168.1.176:443 SYMANTEC_WEB_GATEWAY - Failed: 'sinn3r:BadPass'
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf auxiliary(symantec_web_gateway_login) &gt;
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2019 - 2020 darkcode0x00</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
