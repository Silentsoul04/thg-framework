<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="darkcode0x00 luizcorrea">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>The ins and outs of HTTP and HTTPS communications in Meterpreter and Metasploit Stagers - thg-framework</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">thg-framework</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../cli/install/">Installation</a>
</li>
                                    
<li >
    <a href="../../..">Introduction</a>
</li>
                                    
<li >
    <a href="../../../community/">Community</a>
</li>
                                    
<li >
    <a href="../../../conceptual/">Conceptual</a>
</li>
                                    
<li >
    <a href="../../../cli/build/">build</a>
</li>
                                    
<li >
    <a href="../../../cli/tags/">tags</a>
</li>
                                    
<li >
    <a href="../../../LICENSE/">LICENSE</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">thg_dev <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">gettin_started</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/_Sidebar/">thg_Development_Environment</a>
</li>
            
<li >
    <a href="../../thg_dev/Using-thg/">using_thg</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">git</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../git/Using-Git/">Using-Git</a>
</li>
            
<li >
    <a href="../../git/Git-cheatsheet/">Git_cheatsheet</a>
</li>
            
<li >
    <a href="../../git/Git-Reference-Sites/">Git-Reference-Sites</a>
</li>
    </ul>
  </li>
            
<li >
    <a href="../../thg_dev/Reporting-a-Bug/">reporting_a_bug</a>
</li>
            
<li >
    <a href="../../contributing/Contributing-to-thg/">Get Started</a>
</li>
            
<li >
    <a href="../../../cli/templates/">templates</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Roadmaps</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">2019</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap/">Roadmap</a>
</li>
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap-Review/">Roadmap_Review</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">contributing</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/Contributing-to-thg/">contributing_to_thg</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">thg_development</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">thg_how_to</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../thg_dev/How-to-get-started-with-writing-an-exploit/">How to get started with writing an exploit</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-get-started-with-writing-an-auxiliary-module/">How to get started with writing an auxiliary module</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-get-started-with-writing-a-post-module/">How to get started with writing a postmodule</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-get-started-with-writing-a-Meterpreter-script/">How to get started with writing a script</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-check-Microsoft-patch-levels-for-your-exploit/">How to check Microsoft patch levels for your exploit</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-clean-up-files-using-XCybrerFileDropper/">How to clean up files using FileDropper</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-deprecate-a-Metasploit-module/">How to deprecate a Metasploit module</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-do-reporting-or-store-data-in-module-development/">How to do reporting or store data in module development</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-log-in-Metasploit/">How to log in THG</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-obfuscate-JavaScript-in-Metasploit/">How to obfuscate JavaScript in Metasploit</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-parse-an-HTTP-response/">How to parse an HTTP response</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-Send-an-HTTP-Request-Using-HTTPClient/">How to Send an HTTP Request Using HTTPClient</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-send-an-HTTP-request-using-Rex-Proto-Http-Client/">How to send an HTTP request using Rex Proto Http Client</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-command-stagers/">How to use command stagers</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-datastore-options/">How to use datastore options</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-Msf-Auxiliary-AuthBrute-to-write-a-bruteforcer/">How to use Msf Auxiliary AuthBrute to write a bruteforcer</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-PhpEXE-to-exploit-an-arbitrary-file-upload-bug/">How to use PhpEXE to exploit an arbitrary file upload bug</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-Powershell-in-an-exploit/">How to use Powershell in an exploit</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-Railgun-for-Windows-post-exploitation/">How to use Railgun for Windows post exploitation</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit/">How to Use the FILEFORMAT mixin to create a file format exploit</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-the-Msf-Exploit-Remote-Tcp-mixin/">How to use the Msf Exploit Remote Tcp mixin</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-the-Seh-mixin-to-exploit-an-exception-handler/">How to use the Seh mixin to exploit an exception handler</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows/">How to use WbemExec for a write privilege attack on Windows</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-write-a-browser-exploit-using-BrowserExploitServer/">How to write a browser exploit using BrowserExploitServer</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-write-a-browser-exploit-using-HttpServer/">How to write a browser exploit using HttpServer</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-write-a-check()-method/">How to write a check() method</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-write-a-HTTP-LoginScanner-Module/">How to write a HTTP LoginScanner Module</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-write-a-module-using-HttpServer-and-HttpClient/">How to write a module using HttpServer and HttpClient</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-zip-files-with-Rex-Zip-Archive.md">How to zip files with Rex Zip Archive</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-use-Metasploit-Framework-Obfuscation-CRandomizer/">How to use Metasploit Framework Compiler Windows to compile C code</a>
</li>
            
<li >
    <a href="../../thg_dev/How to use Metasploit Framework Obfuscation CRandomizer">How to use Metasploit Framework Obfuscation CRandomizer</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-decrypt-RC4-with-Metasploit-Framework-Compiler/">How to decrypt RC4 with Metasploit Framework Compiler</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-decode-Base64-with-thg-Framework-Compiler.md">How to decode Base64 with tgh Framework Compiler</a>
</li>
            
<li >
    <a href="../../thg_dev/How-to-XOR-with-thg-Framework-Compiler.md">How to XOR with thg Framework Compiler</a>
</li>
    </ul>
  </li>
            
<li >
    <a href="../../thg_dev/Style_Tips/">Style_Tips</a>
</li>
            
<li >
    <a href="../../thg_dev/Running-Private-Modules/">Running Private Modules</a>
</li>
            
<li >
    <a href="../../thg_dev/Exploit-Ranking/">Exploit Ranking</a>
</li>
            
<li >
    <a href="../../thg_dev/THG-module-reference-identifiers/">THG module reference identifiers</a>
</li>
            
<li >
    <a href="../../thg_dev/Using-ReflectiveDll-Injection.md">Using ReflectiveDll Injection</a>
</li>
            
<li >
    <a href="../../thg_dev/Oracle-Usage.md">Oracle Usage</a>
</li>
            
<li >
    <a href="../../thg_dev/Rex-Layout.md">Rex Layout</a>
</li>
            
<li >
    <a href="../../thg_dev/">Definition of Module Reliability, Side Effects, and Stability</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">capture the flag</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">basic</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/analysis/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/malware/">malware</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">recovery</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/recover/backuo/">backup</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/recover/patching/">patching</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">tips_end_tricks</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/tools/">tools</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/decoding/">decoding</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/dos/">dos</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/os_cheats/">os_cheats</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/snort/">snort</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/identify/basic/">basic</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nmap/">nmap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nessus/">nessus</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/openvas/">openvas</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">defend</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/tcpdump/">tcpdump</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/editcap/">edicap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/mergecap/">mergecap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/snort/">snort</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/tshark/">tshark</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/analysis/">analysis</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">os</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/windows/">windows</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
<li >
    <a href="../../../deployment/">Deployment</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">hash_crack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/hash_crack/">index</a>
</li>
            
<li >
    <a href="../../../capturetheflag/hash_crack/CORE_HASH_CRACKING_KNOWLEDGE/">CORE_HASH_CRACKING_KNOWLEDGE</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">pentest_standard</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../pentest_standard/preengagemente/">Pre engagement Interactions</a>
</li>
            
<li >
    <a href="../../../pentest_standard/ig/">Intelligence Gathering</a>
</li>
            
<li >
    <a href="../../../pentest_standard/threatmodeling/">Threat Modeling</a>
</li>
            
<li >
    <a href="../../../pentest_standard/vulnterability/">Vulnerability Analysis</a>
</li>
            
<li >
    <a href="../../../pentest_standard/exploration/">Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/postexploration/">Post Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/report/">Reporting</a>
</li>
            
<li >
    <a href="../../../pentest_standard/tecguidelines/">Technical Guidelines</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">CLI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-1</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/thg/">THG</a>
</li>
            
<li >
    <a href="../../../tutorials/server/server/">thg_server</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/shells/shells/">thg_shells</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_docs/thg_docs/">thg_docs</a>
</li>
            
<li >
    <a href="../../../tutorials/auxiliares/auxiliares/">thg_auxiliares</a>
</li>
            
<li >
    <a href="../../../tutorials/anti_forensic/anti_forensic/">thg_anti_forensic</a>
</li>
            
<li >
    <a href="../../../tutorials/crypto/crypto/">thg_crypto</a>
</li>
            
<li >
    <a href="../../../tutorials/drone/drone/">thg_drone</a>
</li>
            
<li >
    <a href="../../../tutorials/keylogger/keylogger/">thg_keylogger</a>
</li>
            
<li >
    <a href="../../../tutorials/recon/recon/">thg_recon</a>
</li>
            
<li >
    <a href="../../../tutorials/voip/voip/">thg_voip</a>
</li>
            
<li >
    <a href="../../../tutorials/automation/automation/">thg_automation</a>
</li>
            
<li >
    <a href="../../../tutorials/cryptography/cryptography/">thg_cryptography</a>
</li>
            
<li >
    <a href="../../../tutorials/exploitation/exploitation/">thg_exploitation</a>
</li>
            
<li >
    <a href="../../../tutorials/malware/malware/">thg_malware</a>
</li>
            
<li >
    <a href="../../../tutorials/reversing/reversing/">thg_reversing</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_windows/thg_windows/">thg_windows</a>
</li>
            
<li >
    <a href="../../../tutorials/automobile/automobile/">thg_automobile</a>
</li>
            
<li >
    <a href="../../../tutorials/database/database/">thg_database</a>
</li>
            
<li >
    <a href="../../../tutorials/fingerprint/fingerprint/">thg_fingerprint</a>
</li>
            
<li >
    <a href="../../../tutorials/misc/misc/">thg_misc</a>
</li>
            
<li >
    <a href="../../../tutorials/sniffer/sniffer/">thg_sniffer</a>
</li>
            
<li >
    <a href="../../../tutorials/wireless/wireless/">thg_wireless</a>
</li>
            
<li >
    <a href="../../../tutorials/debugger/debugger/">thg_debugger</a>
</li>
            
<li >
    <a href="../../../tutorials/firmware/firmware/">thg_firmware</a>
</li>
            
<li >
    <a href="../../../tutorials/mobile/mobile/">thg_mobile</a>
</li>
            
<li >
    <a href="../../../tutorials/social/social/">thg_social</a>
</li>
            
<li >
    <a href="../../../tutorials/backdoor/backdoor/">thg_backdoor</a>
</li>
            
<li >
    <a href="../../../tutorials/decompiler/decompiler/">thg_decompiler</a>
</li>
            
<li >
    <a href="../../../tutorials/forensic/forensic/">thg_forensic</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-2</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/networking/networking/">thg_networking</a>
</li>
            
<li >
    <a href="../../../tutorials/spoff/spoff/">thg_spoff</a>
</li>
            
<li >
    <a href="../../../tutorials/binary/binary/">thg_binary</a>
</li>
            
<li >
    <a href="../../../tutorials/defensensive/defensensive/">thg_defensensive</a>
</li>
            
<li >
    <a href="../../../tutorials/gpu/gpu/">thg_gpu</a>
</li>
            
<li >
    <a href="../../../tutorials/os/os/">thg_os</a>
</li>
            
<li >
    <a href="../../../tutorials/nfc/nfc/">thg_nfc</a>
</li>
            
<li >
    <a href="../../../tutorials/spoof/spoof/">thg_spoof</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/bluetooth/bluetooth/">thg_bluetooth</a>
</li>
            
<li >
    <a href="../../../tutorials/defensive/defensive/">thg_defensive</a>
</li>
            
<li >
    <a href="../../../tutorials/hardware/hardware/">thg_hardware</a>
</li>
            
<li >
    <a href="../../../tutorials/packer/packer/">thg_packer</a>
</li>
            
<li >
    <a href="../../../tutorials/stego/stego/">thg_stego</a>
</li>
            
<li >
    <a href="../../../tutorials/code_audit/code_audit/">thg_code_audit</a>
</li>
            
<li >
    <a href="../../../tutorials/disassembler/disassembler/">thg_disassembler</a>
</li>
            
<li >
    <a href="../../../tutorials/honeypot/honeypot/">thg_honeypot</a>
</li>
            
<li >
    <a href="../../../tutorials/proxy/proxy/">thg_proxy</a>
</li>
            
<li >
    <a href="../../../tutorials/tunnel/tunnel/">thg_tunnel</a>
</li>
            
<li >
    <a href="../../../tutorials/cracker/cracker/">thg_cracker</a>
</li>
            
<li >
    <a href="../../../tutorials/dos/dos/">thg_dos</a>
</li>
            
<li >
    <a href="../../../tutorials/ids/ids/">thg_ids</a>
</li>
            
<li >
    <a href="../../../tutorials/radio/radio/">thg_radio</a>
</li>
            
<li >
    <a href="../../../tutorials/unpacker/unpacker/">thg_unpacker</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li>
                                <a href="https://github.com/darkcode357/thg-framework/edit/master/docs/dev/dark/The-ins-and-outs-of-HTTP-and-HTTPS-communications-in-Meterpreter-and-Metasploit-Stagers.md">Edit on darkcode357/thg-framework</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#windows-http-apis">Windows HTTP APIs</a></li>
        <li class="main "><a href="#meterpreters-implementation">Meterpreter's Implementation</a></li>
        <li class="main "><a href="#metasploit-http-and-https-stagers">Metasploit HTTP and HTTPS Stagers</a></li>
        <li class="main "><a href="#combining-stagers-with-meterpreter">Combining Stagers with Meterpreter</a></li>
        <li class="main "><a href="#conclusion">Conclusion</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p>Recent changes to HTTP and HTTPS communications in both Meterpreter and its stagers have caused new behaviours that have left some users confused. The aim of this post is to cover the changes that have been made, the rationale behind those changes, and the issues that come with them. By the end of this post, readers should have a clear understanding of the issues related to HTTP/S communications, and be able to diagnose and fix any issues that they might be having.</p>
<h2 id="windows-http-apis">Windows HTTP APIs</h2>
<p>The Windows API comes with two ways to talk via HTTP/S, they are <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a>. The APIs are consumed in a similar fashion; many of the functions in each have the same interface, or are at least close enough to make a transition between the two rather trivial. However, there are some underlying differences that are important.</p>
<p>The <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> API was designed for use in desktop applications. It provides all the features required by applications to use HTTP/S while delegating much of the responsibilty of handling implementation detail to the underlying API and OS. This API can result in some user interface elements appearing if not handled correctly.</p>
<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> comes with some limitations, one of which is that it's close to impossible to do any kind of custom validation, parsing, or handling of SSL communications. One of the needs of Metasploit users is to be able to enable a <a href="https://github.com/rapid7/metasploit-framework/wiki/Meterpreter-Paranoid-Mode">Paranoid Mode</a> that forces Meterpreter to only talk with the appropriate endpoint. The goal is to prevent shells from being hijacked by unauthorised users. In order to do this, one of the things that was implemented was the verification of the SHA1 hash of the SSL certificate that Meterpreter reads from the server. If this hash doesn't match the one that Meterpreter is configured with, Meterpreter will shut down. <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> doesn't make this process possible without a <em>lot</em> of custom work.</p>
<p>For applications such as this, <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a> is the "preferred" option as deemed by Microsoft. This API is designed to work under a service, and provides a greater number of ways to interact with communications made over HTTP/S. With this API it was trivial to implement the SHA1 hash verification and force Meterpreter to shut down when a MITM is detected.</p>
<p>For a full comparison of the feature differences, please see <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh227298%28v=vs.85%29.aspx">this feature matrix</a> on MSDN.</p>
<h2 id="meterpreters-implementation">Meterpreter's Implementation</h2>
<p>Meterpreter now makes use of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a> by default so that the new features are accommodated, but unfortuanetly this doesn't come for free. Behind the scenes, this API does not make any use of the current user's Internet Explorer configuration settings, where the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> API does. This means that if the current user has a proxy configured, extra code needs to be added to make use of the current Internet Explorer settings in <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a>. Meterpreter has been modified to do this, however there is still one limitation that is in place.</p>
<p>As indicated in a <a href="http://blogs.msdn.com/b/httpcontext/archive/2012/02/21/changes-in-winhttp-on-windows-7-and-onwards-wrto-http-1-0.aspx">blog post on MSDN</a>:</p>
<blockquote>
<p>WinHTTP strictly requires HTTP/1.1 compliance for keeping the connection alive and HTTP Keep-Alives are not supported in HTTP/1.0 protocol. HTTP Keep-Alive feature was introduced in the HTTP/1.1 protocol as per RFC 2616. The server or the proxy which expects the keep-alive should also implement the protocol correctly. WinHTTP on Windows 7, Windows 2008 R2 are strict in terms of security wrto protocol compliance. The ideal solution is to change the server/proxy to use the right protocol and be RFC compliant.</p>
</blockquote>
<p>What this means is that from Windows 7 and onwards, the underlying <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a> implementation requires proper HTTP/1.1 support from any proxies that are used. If a proxy uses HTTP/1.0, such as Squid 2.7, and requires <code>Keep-Alive</code> support, such as NTLM authentication, then <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a> will refuse to talk to it. Instead of downgrading, it will expect a purely RFC-compliant implementation, and instead will return a <code>407</code> error the client. This means that for Meterpreter to work, <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a> can't be used.</p>
<p>In order to avoid this issue, <a href="https://github.com/rapid7/metasploit-payloads/pull/5">extra work</a> has beeen done to force Meterpreter to fall back to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> when this happens. Given that <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> doesn't do certificate hash verification, this means that the user of Meterpreter loses the ability to use paranoid mode. It was decided that Meterpreter would not fallback to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> if paranoid mode was enabled, as the intention of the user is clearly to avoid MITM.</p>
<p>To sum up, Meterpreter will use <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a> where it can. If it can't, it'll fall back to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> <em>unless</em> paranoid mode is enabled.</p>
<h2 id="metasploit-http-and-https-stagers">Metasploit HTTP and HTTPS Stagers</h2>
<p>Metasploit users have long since known about the <code>reverse_http</code> and <code>reverse_https</code> stagers, and have made good use of them over time. What many <em>don't</em> know is that these stagers use the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> API, which means that they don't get SSL certificate validation (so no paranoid mode).</p>
<p>To provide support for paranoid mode directly inside the stager, ultimately preventing the download of Meterpreter <em>at all</em> in the case of MITM, new stagers were required. <code>reverse_winhttp</code> and <code>reverse_winhttps</code> are implementations of stagers that make use of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a>, and in the latter case, provides support for paranoid mode. They do, however come with the same implicit limitation as Meterpreter itself in that they may not be able to provide proxy support thanks to the strict RFC compliance described in the previous section. The big difference here is that the stager does <em>not</em> have a fallback implementation like Meterpreter does, as this would make the stager way too big. Therefore, if an older proxy is in place that doesn't confirm to HTTP/1.1, the stager will fail.</p>
<h2 id="combining-stagers-with-meterpreter">Combining Stagers with Meterpreter</h2>
<p>It's important to note that the implementations of communications inside the stagers are completely separate to those inside Meterpreter. If you use <code>windows/meterpreter/reverse_https</code>, then the stager will use <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> and Meterpreter will use <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a>. It isn't possible to "hand over" communications from the stager to Meterpreter in this case, and it wouldn't make sense anyway because HTTP/S is stateless. This is the most common set up because many people don't realise that the <code>reverse_winhttp/s</code> payloads exist!</p>
<p>Prior to the <a href="https://github.com/rapid7/metasploit-payloads/pull/5">WinInet fallback</a> work, those people hitting the HTTP/1.0 proxy issue would find themselves with the following scenario:</p>
<ol>
<li>They would exploit a Windows 7 (or later) target in some way, whether it be via a browser exploit, or through a social engineering attack.</li>
<li>The payload that was executed was <code>meterpreter/reverse_https</code>, and so the initial connection would come via <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a>.</li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx">WinInet</a> would successfully use the current user's proxy configuration and the initial connection back to Metasploit would be successful.</li>
<li>The stager would download the second stage (<code>metsrv</code>), and reflectively load it so that Meterpreter could take over.</li>
<li>Meterpreter would attempt to connect again to Metasploit, this time using <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a>.</li>
<li>The proxy would return HTTP/1.0 responses, resulting in <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx">WinHTTP</a> refusing to function.</li>
<li>The Meterpreter session would be considered "dead" by Metasploit as a result of the lack of successful communications after staging.</li>
</ol>
<p>Examples of these issues are <a href="https://github.com/rapid7/metasploit-framework/issues/5462">this</a> and <a href="https://github.com/rapid7/metasploit-framework/issues/5626">this</a>. If you are seeing similar issues it's because your current Meterpreter binaries don't have the fallback option.</p>
<h2 id="conclusion">Conclusion</h2>
<p>HTTP/S communications in Windows is a hairy beast, and trying to cater for all cases proves to be quite tricky thanks to the limitations of some APIs, and the variable implementations of others. We're still working to iron out all of issues, and so please log an issue if you stumble on an edge case that hasn't yet been covered. Thank you for your patience!</p>
<p><a href="https://github.com/OJ">OJ</a> / <a href="https://twitter.com/TheColonial">@TheColonial</a></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2019 - 2020 darkcode0x00</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
