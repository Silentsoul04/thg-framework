<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="darkcode0x00 luizcorrea">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>How to obfuscate JavaScript in Metasploit - thg-framework</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">thg-framework</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../cli/install/">Installation</a>
</li>
                                    
<li >
    <a href="../../..">Introduction</a>
</li>
                                    
<li >
    <a href="../../../community/">Community</a>
</li>
                                    
<li >
    <a href="../../../conceptual/">Conceptual</a>
</li>
                                    
<li >
    <a href="../../../cli/build/">build</a>
</li>
                                    
<li >
    <a href="../../../cli/tags/">tags</a>
</li>
                                    
<li >
    <a href="../../../LICENSE/">LICENSE</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">thg_dev <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">gettin_started</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../_Sidebar/">thg_Development_Environment</a>
</li>
            
<li >
    <a href="../Using-thg/">using_thg</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">git</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../git/Using-Git/">Using-Git</a>
</li>
            
<li >
    <a href="../../git/Git-cheatsheet/">Git_cheatsheet</a>
</li>
            
<li >
    <a href="../../git/Git-Reference-Sites/">Git-Reference-Sites</a>
</li>
    </ul>
  </li>
            
<li >
    <a href="../Reporting-a-Bug/">reporting_a_bug</a>
</li>
            
<li >
    <a href="../../contributing/Contributing-to-thg/">Get Started</a>
</li>
            
<li >
    <a href="../../../cli/templates/">templates</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Roadmaps</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">2019</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap/">Roadmap</a>
</li>
            
<li >
    <a href="../../roadmaps/2019/2019-Roadmap-Review/">Roadmap_Review</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">contributing</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../Contributing-to-thg/">contributing_to_thg</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">thg_development</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">thg_how_to</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../How-to-get-started-with-writing-an-exploit/">How to get started with writing an exploit</a>
</li>
            
<li >
    <a href="../How-to-get-started-with-writing-an-auxiliary-module/">How to get started with writing an auxiliary module</a>
</li>
            
<li >
    <a href="../How-to-get-started-with-writing-a-post-module/">How to get started with writing a postmodule</a>
</li>
            
<li >
    <a href="../How-to-get-started-with-writing-a-Meterpreter-script/">How to get started with writing a script</a>
</li>
            
<li >
    <a href="../How-to-check-Microsoft-patch-levels-for-your-exploit/">How to check Microsoft patch levels for your exploit</a>
</li>
            
<li >
    <a href="../How-to-clean-up-files-using-XCybrerFileDropper/">How to clean up files using FileDropper</a>
</li>
            
<li >
    <a href="../How-to-deprecate-a-Metasploit-module/">How to deprecate a Metasploit module</a>
</li>
            
<li >
    <a href="../How-to-do-reporting-or-store-data-in-module-development/">How to do reporting or store data in module development</a>
</li>
            
<li >
    <a href="../How-to-log-in-Metasploit/">How to log in THG</a>
</li>
            
<li class="active">
    <a href="./">How to obfuscate JavaScript in Metasploit</a>
</li>
            
<li >
    <a href="../How-to-parse-an-HTTP-response/">How to parse an HTTP response</a>
</li>
            
<li >
    <a href="../How-to-Send-an-HTTP-Request-Using-HTTPClient/">How to Send an HTTP Request Using HTTPClient</a>
</li>
            
<li >
    <a href="../How-to-send-an-HTTP-request-using-Rex-Proto-Http-Client/">How to send an HTTP request using Rex Proto Http Client</a>
</li>
            
<li >
    <a href="../How-to-use-command-stagers/">How to use command stagers</a>
</li>
            
<li >
    <a href="../How-to-use-datastore-options/">How to use datastore options</a>
</li>
            
<li >
    <a href="../How-to-use-Msf-Auxiliary-AuthBrute-to-write-a-bruteforcer/">How to use Msf Auxiliary AuthBrute to write a bruteforcer</a>
</li>
            
<li >
    <a href="../How-to-use-PhpEXE-to-exploit-an-arbitrary-file-upload-bug/">How to use PhpEXE to exploit an arbitrary file upload bug</a>
</li>
            
<li >
    <a href="../How-to-use-Powershell-in-an-exploit/">How to use Powershell in an exploit</a>
</li>
            
<li >
    <a href="../How-to-use-Railgun-for-Windows-post-exploitation/">How to use Railgun for Windows post exploitation</a>
</li>
            
<li >
    <a href="../How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit/">How to Use the FILEFORMAT mixin to create a file format exploit</a>
</li>
            
<li >
    <a href="../How-to-use-the-Msf-Exploit-Remote-Tcp-mixin/">How to use the Msf Exploit Remote Tcp mixin</a>
</li>
            
<li >
    <a href="../How-to-use-the-Seh-mixin-to-exploit-an-exception-handler/">How to use the Seh mixin to exploit an exception handler</a>
</li>
            
<li >
    <a href="../How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows/">How to use WbemExec for a write privilege attack on Windows</a>
</li>
            
<li >
    <a href="../How-to-write-a-browser-exploit-using-BrowserExploitServer/">How to write a browser exploit using BrowserExploitServer</a>
</li>
            
<li >
    <a href="../How-to-write-a-browser-exploit-using-HttpServer/">How to write a browser exploit using HttpServer</a>
</li>
            
<li >
    <a href="../How-to-write-a-check()-method/">How to write a check() method</a>
</li>
            
<li >
    <a href="../How-to-write-a-HTTP-LoginScanner-Module/">How to write a HTTP LoginScanner Module</a>
</li>
            
<li >
    <a href="../How-to-write-a-module-using-HttpServer-and-HttpClient/">How to write a module using HttpServer and HttpClient</a>
</li>
            
<li >
    <a href="../How-to-zip-files-with-Rex-Zip-Archive.md">How to zip files with Rex Zip Archive</a>
</li>
            
<li >
    <a href="../How-to-use-Metasploit-Framework-Obfuscation-CRandomizer/">How to use Metasploit Framework Compiler Windows to compile C code</a>
</li>
            
<li >
    <a href="../How to use Metasploit Framework Obfuscation CRandomizer">How to use Metasploit Framework Obfuscation CRandomizer</a>
</li>
            
<li >
    <a href="../How-to-decrypt-RC4-with-Metasploit-Framework-Compiler/">How to decrypt RC4 with Metasploit Framework Compiler</a>
</li>
            
<li >
    <a href="../How-to-decode-Base64-with-thg-Framework-Compiler.md">How to decode Base64 with tgh Framework Compiler</a>
</li>
            
<li >
    <a href="../How-to-XOR-with-thg-Framework-Compiler.md">How to XOR with thg Framework Compiler</a>
</li>
    </ul>
  </li>
            
<li >
    <a href="../Style_Tips/">Style_Tips</a>
</li>
            
<li >
    <a href="../Running-Private-Modules/">Running Private Modules</a>
</li>
            
<li >
    <a href="../Exploit-Ranking/">Exploit Ranking</a>
</li>
            
<li >
    <a href="../THG-module-reference-identifiers/">THG module reference identifiers</a>
</li>
            
<li >
    <a href="../Using-ReflectiveDll-Injection.md">Using ReflectiveDll Injection</a>
</li>
            
<li >
    <a href="../Oracle-Usage.md">Oracle Usage</a>
</li>
            
<li >
    <a href="../Rex-Layout.md">Rex Layout</a>
</li>
            
<li >
    <a href="../">Definition of Module Reliability, Side Effects, and Stability</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">capture the flag</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">basic</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/analysis/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/analysis/malware/">malware</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">recovery</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/recover/backuo/">backup</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/recover/patching/">patching</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">tips_end_tricks</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/tools/">tools</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/decoding/">decoding</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/dos/">dos</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/os_cheats/">os_cheats</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/tips_end_tricks/snort/">snort</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/identify/basic/">basic</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nmap/">nmap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/nessus/">nessus</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/openvas/">openvas</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/identify/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">defend</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/windows/">windows</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/prootect_defend/linux/">linux</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">identify</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/tcpdump/">tcpdump</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/editcap/">edicap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/mergecap/">mergecap</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/snort/">snort</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/tshark/">tshark</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/analysis/">analysis</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">os</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/basic/detect/linux/">linux</a>
</li>
            
<li >
    <a href="../../../capturetheflag/basic/detect/windows/">windows</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
<li >
    <a href="../../../deployment/">Deployment</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">hash_crack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../capturetheflag/hash_crack/">index</a>
</li>
            
<li >
    <a href="../../../capturetheflag/hash_crack/CORE_HASH_CRACKING_KNOWLEDGE/">CORE_HASH_CRACKING_KNOWLEDGE</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">pentest_standard</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../pentest_standard/preengagemente/">Pre engagement Interactions</a>
</li>
            
<li >
    <a href="../../../pentest_standard/ig/">Intelligence Gathering</a>
</li>
            
<li >
    <a href="../../../pentest_standard/threatmodeling/">Threat Modeling</a>
</li>
            
<li >
    <a href="../../../pentest_standard/vulnterability/">Vulnerability Analysis</a>
</li>
            
<li >
    <a href="../../../pentest_standard/exploration/">Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/postexploration/">Post Exploitation</a>
</li>
            
<li >
    <a href="../../../pentest_standard/report/">Reporting</a>
</li>
            
<li >
    <a href="../../../pentest_standard/tecguidelines/">Technical Guidelines</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">CLI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-1</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/thg/">THG</a>
</li>
            
<li >
    <a href="../../../tutorials/server/server/">thg_server</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/shells/shells/">thg_shells</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_docs/thg_docs/">thg_docs</a>
</li>
            
<li >
    <a href="../../../tutorials/auxiliares/auxiliares/">thg_auxiliares</a>
</li>
            
<li >
    <a href="../../../tutorials/anti_forensic/anti_forensic/">thg_anti_forensic</a>
</li>
            
<li >
    <a href="../../../tutorials/crypto/crypto/">thg_crypto</a>
</li>
            
<li >
    <a href="../../../tutorials/drone/drone/">thg_drone</a>
</li>
            
<li >
    <a href="../../../tutorials/keylogger/keylogger/">thg_keylogger</a>
</li>
            
<li >
    <a href="../../../tutorials/recon/recon/">thg_recon</a>
</li>
            
<li >
    <a href="../../../tutorials/voip/voip/">thg_voip</a>
</li>
            
<li >
    <a href="../../../tutorials/automation/automation/">thg_automation</a>
</li>
            
<li >
    <a href="../../../tutorials/cryptography/cryptography/">thg_cryptography</a>
</li>
            
<li >
    <a href="../../../tutorials/exploitation/exploitation/">thg_exploitation</a>
</li>
            
<li >
    <a href="../../../tutorials/malware/malware/">thg_malware</a>
</li>
            
<li >
    <a href="../../../tutorials/reversing/reversing/">thg_reversing</a>
</li>
            
<li >
    <a href="../../../tutorials/thg_windows/thg_windows/">thg_windows</a>
</li>
            
<li >
    <a href="../../../tutorials/automobile/automobile/">thg_automobile</a>
</li>
            
<li >
    <a href="../../../tutorials/database/database/">thg_database</a>
</li>
            
<li >
    <a href="../../../tutorials/fingerprint/fingerprint/">thg_fingerprint</a>
</li>
            
<li >
    <a href="../../../tutorials/misc/misc/">thg_misc</a>
</li>
            
<li >
    <a href="../../../tutorials/sniffer/sniffer/">thg_sniffer</a>
</li>
            
<li >
    <a href="../../../tutorials/wireless/wireless/">thg_wireless</a>
</li>
            
<li >
    <a href="../../../tutorials/debugger/debugger/">thg_debugger</a>
</li>
            
<li >
    <a href="../../../tutorials/firmware/firmware/">thg_firmware</a>
</li>
            
<li >
    <a href="../../../tutorials/mobile/mobile/">thg_mobile</a>
</li>
            
<li >
    <a href="../../../tutorials/social/social/">thg_social</a>
</li>
            
<li >
    <a href="../../../tutorials/backdoor/backdoor/">thg_backdoor</a>
</li>
            
<li >
    <a href="../../../tutorials/decompiler/decompiler/">thg_decompiler</a>
</li>
            
<li >
    <a href="../../../tutorials/forensic/forensic/">thg_forensic</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">THG-PART-2</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../tutorials/networking/networking/">thg_networking</a>
</li>
            
<li >
    <a href="../../../tutorials/spoff/spoff/">thg_spoff</a>
</li>
            
<li >
    <a href="../../../tutorials/binary/binary/">thg_binary</a>
</li>
            
<li >
    <a href="../../../tutorials/defensensive/defensensive/">thg_defensensive</a>
</li>
            
<li >
    <a href="../../../tutorials/gpu/gpu/">thg_gpu</a>
</li>
            
<li >
    <a href="../../../tutorials/os/os/">thg_os</a>
</li>
            
<li >
    <a href="../../../tutorials/nfc/nfc/">thg_nfc</a>
</li>
            
<li >
    <a href="../../../tutorials/spoof/spoof/">thg_spoof</a>
</li>
            
<li >
    <a href="../../../tutorials/version/version/">thg_version</a>
</li>
            
<li >
    <a href="../../../tutorials/bluetooth/bluetooth/">thg_bluetooth</a>
</li>
            
<li >
    <a href="../../../tutorials/defensive/defensive/">thg_defensive</a>
</li>
            
<li >
    <a href="../../../tutorials/hardware/hardware/">thg_hardware</a>
</li>
            
<li >
    <a href="../../../tutorials/packer/packer/">thg_packer</a>
</li>
            
<li >
    <a href="../../../tutorials/stego/stego/">thg_stego</a>
</li>
            
<li >
    <a href="../../../tutorials/code_audit/code_audit/">thg_code_audit</a>
</li>
            
<li >
    <a href="../../../tutorials/disassembler/disassembler/">thg_disassembler</a>
</li>
            
<li >
    <a href="../../../tutorials/honeypot/honeypot/">thg_honeypot</a>
</li>
            
<li >
    <a href="../../../tutorials/proxy/proxy/">thg_proxy</a>
</li>
            
<li >
    <a href="../../../tutorials/tunnel/tunnel/">thg_tunnel</a>
</li>
            
<li >
    <a href="../../../tutorials/cracker/cracker/">thg_cracker</a>
</li>
            
<li >
    <a href="../../../tutorials/dos/dos/">thg_dos</a>
</li>
            
<li >
    <a href="../../../tutorials/ids/ids/">thg_ids</a>
</li>
            
<li >
    <a href="../../../tutorials/radio/radio/">thg_radio</a>
</li>
            
<li >
    <a href="../../../tutorials/unpacker/unpacker/">thg_unpacker</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../How-to-log-in-Metasploit/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../How-to-parse-an-HTTP-response/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/darkcode357/thg-framework/edit/master/docs/dev/thg_dev/How-to-obfuscate-JavaScript-in-Metasploit.md">Edit on darkcode357/thg-framework</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#the-rand_text_alpha-trick">The rand_text_alpha trick</a></li>
        <li class="main "><a href="#the-obfuscatejs-class">The ObfuscateJS class</a></li>
        <li class="main "><a href="#the-jsobfu-class">The JSObfu class</a></li>
        <li class="main "><a href="#references">Reference(s)</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p>Stealth is an important feature to think about during exploit development. If your exploit gets caught all the time, it doesn't matter how awesome or how technically challenging your exploit is, it is most likely not very usable in a real penetration test. Browser exploits in particular, heavily rely on JavaScript to trigger vulnerabilities, therefore a lot of antivirus or signature-based intrusion detection/prevention systems will scan the JavaScript and flag specific lines as malicious. The following code used to be considered as MS12-063 by multiple <a href="https://www.virustotal.com/en/file/90fdf2beab48cf3c269f70d8c9cf7736f3442430ea023d06b65ff073f724870e/analysis/1388888489/">antivirus vendors</a> even though it is not necessarily harmful or malicious, we'll use this as an example throughout the wiki:</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">arrr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
<span class="nx">arrr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">windows</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">);</span>
<span class="nx">arrr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;src&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">;</span>
</pre></div>

<p>To avoid getting flagged, there are some common evasive tricks we can try. For example, you can manually modify the code a little bit to make it not recognizable by any signatures. Or if the antivirus relies on cached webpages to scan for exploits, it is possible to make the browser not cache your exploit so you stay undetected. Or in this case, you can obfuscate your code, which is what this writeup will focus on.</p>
<p>In Metasploit, there are three common ways to obfuscate your JavaScript. The first one is simply by using the <code>rand_text_alpha</code> method (in <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/text.rb#L1223">Rex</a>) to randomize your variables. The second one is by using the <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/obfuscatejs.rb">ObfuscateJS</a> class. And the third option is the <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/jsobfu.rb">JSObfu</a> class.</p>
<h2 id="the-rand_text_alpha-trick">The rand_text_alpha trick</h2>
<p>Using <code>rand_text_alpha</code> is the most basic form of evasion, but also the least effective. If this is your choice, you should randomize whatever can be randomized without breaking the code.</p>
<p>By using the above MS12-063, here's how you would use <code>rand_text_alpha</code>:</p>
<div class="highlight"><pre><span></span><span class="c1"># Randomizes the array variable</span>
<span class="c1"># Max size = 6, Min = 3</span>
<span class="n">var_array</span> <span class="o">=</span> <span class="n">rand_text_alpha</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Randomizes the src value</span>
<span class="n">val_src</span>   <span class="o">=</span> <span class="n">rand_text_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">js</span> <span class="o">=</span> <span class="sx">%Q|</span>
<span class="sx">var </span><span class="si">#{</span><span class="n">var_array</span><span class="si">}</span><span class="sx"> = new Array();</span>
<span class="si">#{</span><span class="n">var_array</span><span class="si">}</span><span class="sx">[0] = windows.document.createElement(&quot;img&quot;);</span>
<span class="si">#{</span><span class="n">var_array</span><span class="si">}</span><span class="sx">[0][&quot;src&quot;] = &quot;</span><span class="si">#{</span><span class="n">val_src</span><span class="si">}</span><span class="sx">&quot;;</span>
<span class="sx">|</span>
</pre></div>

<h2 id="the-obfuscatejs-class">The ObfuscateJS class</h2>
<p>The ObfuscateJS class is like the <code>rand_text_alpha</code> technique on steroids, but even better. It allows you to replace symbol names such as variables, methods, classes, and namespaces. It can also obfuscate strings by either randomly using <code>fromCharCode</code> or <code>unescape</code>. And lastly, it can strip JavaScript comments, which is handy because exploits often are hard to understand and read so you need comments to remember why something is written in a specific way, but you don't want to show or leak those comments in a pentest.</p>
<p>To use ObfuscateJS, let's use the MS12-063 example again to demonstrate. If you feel like following the steps yourself without writing a module, what you can do is go ahead and run <code>msfconsole</code>, and then switch to irb, like this:</p>
<div class="highlight"><pre><span></span>$ ./msfconsole -q
msf &gt; irb
[*] Starting IRB shell...

&gt;&gt; 
</pre></div>

<p>And then you are ready to go.</p>
<p>The first thing you do with ObfuscateJS is you need to initialize it with the JavaScript you want to obfuscate, so in this case, begin like the following:</p>
<div class="highlight"><pre><span></span>js = %Q|
var arrr = new Array();
arrr[0] = windows.document.createElement(&quot;img&quot;);
arrr[0][&quot;src&quot;] = &quot;a&quot;;
|

obfu = ::Rex::Exploitation::ObfuscateJS.new(js)
</pre></div>

<p><code>obfu</code> should return a <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/exploitation/obfuscatejs.rb">Rex::Exploitation::ObfuscateJS</a> object. It allows you to do a lot of things, you can really just call <code>methods</code>, or look at the source to see what methods are available (with additional API documentation). But for demo purposes, we'll showcase the most common one: the <code>obfuscate</code> method.</p>
<p>To actually obfuscate, you need to call the <code>obfuscate</code> method. This method accepts a symbols argument that allows you to manually specify what symbol names (variables, methods, classes, etc) to obfuscate, it should be in a hash like this:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;Variables&#39;</span>  <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;var1&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="o">]</span><span class="p">,</span>
    <span class="s1">&#39;Methods&#39;</span>    <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;method1&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="o">]</span><span class="p">,</span>
    <span class="s1">&#39;Namespaces&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="o">]</span><span class="p">,</span>
    <span class="s1">&#39;Classes&#39;</span>    <span class="o">=&gt;</span> <span class="o">[</span> <span class="p">{</span> <span class="s1">&#39;Namespace&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;Class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="o">...</span> <span class="o">]</span>
<span class="p">}</span>
</pre></div>

<p>So if I want to obfuscate the variable <code>arrr</code>, and I want to obfuscate the src string, here's how:</p>
<div class="highlight"><pre><span></span>&gt;&gt; obfu.obfuscate(&#39;Symbols&#39; =&gt; {&#39;Variables&#39;=&gt;[&#39;arrr&#39;]}, &#39;Strings&#39; =&gt; true)
=&gt; &quot;\nvar QqLFS = new Array();\nQqLFS[0] = windows.document.createElement(unescape(String.fromCharCode(  37, 54, 071, 045, 0x36, 0144, 37, 066, 067 )));\nQqLFS[0][String.fromCharCode(  115, 0x72, 0143 )] = unescape(String.fromCharCode(  045, 0x36, 0x31 ));\n&quot;
</pre></div>

<p>In some cases, you might actually want to know the obfuscated version of a symbol name. One scenario is calling a JavaScript function from an element's event handler, such as this:</p>
<div class="highlight"><pre><span></span>&lt;html&gt;
&lt;head&gt;
&lt;script&gt;
function test() {
    alert(&quot;hello, world!&quot;);
}
&lt;/script&gt;
&lt;/head&gt;
&lt;body onload=&quot;test();&quot;&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>

<p>The obfuscated version would look like the following:</p>
<div class="highlight"><pre><span></span><span class="n">js</span> <span class="o">=</span> <span class="sx">%Q|</span>
<span class="sx">function test() {</span>
<span class="sx">    alert(&quot;hello, world!&quot;);</span>
<span class="sx">}</span>
<span class="sx">|</span>

<span class="n">obfu</span> <span class="o">=</span> <span class="o">::</span><span class="no">Rex</span><span class="o">::</span><span class="no">Exploitation</span><span class="o">::</span><span class="no">ObfuscateJS</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
<span class="n">obfu</span><span class="o">.</span><span class="n">obfuscate</span><span class="p">(</span><span class="s1">&#39;Symbols&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;Methods&#39;</span><span class="o">=&gt;[</span><span class="s1">&#39;test&#39;</span><span class="o">]</span><span class="p">},</span> <span class="s1">&#39;Strings&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>

<span class="n">html</span> <span class="o">=</span> <span class="sx">%Q|</span>
<span class="sx">&lt;html&gt;</span>
<span class="sx">&lt;head&gt;</span>
<span class="sx">&lt;script&gt;</span>
<span class="si">#{</span><span class="n">js</span><span class="si">}</span><span class="sx"></span>
<span class="sx">&lt;/script&gt;</span>
<span class="sx">&lt;/head&gt;</span>
<span class="sx">&lt;body onload=&quot;</span><span class="si">#{</span><span class="n">obfu</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span><span class="si">}</span><span class="sx">();&quot;&gt;</span>
<span class="sx">&lt;/body&gt;</span>
<span class="sx">&lt;/html&gt;</span>
<span class="sx">|</span>

<span class="nb">puts</span> <span class="n">html</span>
</pre></div>

<h2 id="the-jsobfu-class">The JSObfu class</h2>
<p>The JSObfu class used to be ObfuscateJS' cousin, but it has been completely rewritten since September 2014, and packaged as a <a href="https://rubygems.org/gems/jsobfu">gem</a>. The obfuscation is more complex and you can actually tell it to obfuscate multiple times. You also no longer have to manually specify what symbol names to change, it just knows.</p>
<p><strong>Trying JSObfu in Rex</strong></p>
<p>Let's get back to irb again to demonstrate how easy it is to use JSObfu:</p>
<div class="highlight"><pre><span></span>$ ./msfconsole -q
msf &gt; irb
[*] Starting IRB shell...

&gt;&gt; 
</pre></div>

<p>This time we'll do a "hello world" example:</p>
<div class="highlight"><pre><span></span>&gt;&gt; js = ::Rex::Exploitation::JSObfu.new %Q|alert(&#39;hello, world!&#39;);|
=&gt; alert(&#39;hello, world!&#39;);
&gt;&gt; js.obfuscate
=&gt; nil
</pre></div>

<p>And here's the output:</p>
<div class="highlight"><pre><span></span>window[(function () { var _d=&quot;t&quot;,y=&quot;ler&quot;,N=&quot;a&quot;; return N+y+_d })()]((function () { var f=&#39;d!&#39;,B=&#39;orl&#39;,Q2=&#39;h&#39;,m=&#39;ello, w&#39;; return Q2+m+B+f })());
</pre></div>

<p>Like ObfuscateJS, if you need to get the randomized version of a symbol name, you can still do that. We'll demonstrate this with the following example:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">js</span> <span class="o">=</span> <span class="o">::</span><span class="no">Rex</span><span class="o">::</span><span class="no">Exploitation</span><span class="o">::</span><span class="no">JSObfu</span><span class="o">.</span><span class="n">new</span> <span class="sx">%Q|function test() { alert(&quot;hello&quot;); }|</span>
<span class="o">=&gt;</span> <span class="n">function</span> <span class="nb">test</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">alert</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">&gt;&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">obfuscate</span>
</pre></div>

<p>Say we want to know the randomized version of the method name "test":</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="nb">puts</span> <span class="n">js</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">_</span>
</pre></div>

<p>OK, double check right quick:</p>
<div class="highlight"><pre><span></span>&gt;&gt; puts js
function _(){window[(function () { var N=&quot;t&quot;,r=&quot;r&quot;,i=&quot;ale&quot;; return i+r+N })()](String.fromCharCode(0150,0x65,0154,0x6c,0x6f));}
</pre></div>

<p>Yup, that looks good to me.</p>
<p>And finally, let's try to obfuscate a few times to see how that goes:</p>
<div class="highlight"><pre><span></span>&gt;&gt; js = ::Rex::Exploitation::JSObfu.new %Q|alert(&#39;hello, world!&#39;);|
=&gt; alert(&#39;hello, world!&#39;);
&gt;&gt; js.obfuscate(:iterations=&gt;3)
=&gt; window[String[((function(){var s=(function () { var r=&quot;e&quot;; return r })(),Q=(function () { var I=&quot;d&quot;,dG=&quot;o&quot;; return dG+I })(),c=String.fromCharCode(0x66,114),w=(function () { var i=&quot;C&quot;,v=&quot;r&quot;,f=&quot;omCh&quot;,j=&quot;a&quot;; return f+j+v+i })();return c+w+Q+s;})())]((&#39;Urx&#39;.length*((0x1*(01*(1*020+5)+1)+3)*&#39;u&#39;.length+(&#39;SGgdrAJ&#39;.length-7))+((&#39;Iac&#39;.length*&#39;XLR&#39;.length+2)*&#39;qm&#39;.length+0)),((&#39;l&#39;.length*((function () { var vZ=&#39;k&#39;; return vZ })()[((function () { var E=&quot;h&quot;,t=&quot;t&quot;,O=&quot;leng&quot;; return O+t+E })())]*(0x12*1+0)+&#39;xE&#39;.length)+&#39;h&#39;.length)*(function () { var Z=&#39;uA&#39;,J=&#39;tR&#39;,D=&#39;x&#39;; return D+J+Z })()[((function () { var m=&quot;th&quot;,o=&quot;g&quot;,U=&quot;l&quot;,Y=&quot;en&quot;; return U+Y+o+m })())]+&#39;lLc&#39;.length),(&#39;mQ&#39;.length*(02*023+2)+(&#39;Tt&#39;.length*&#39;OEzGiMVf&#39;.length+5)),(String.fromCharCode(0x48,0131)[((function () { var i=&quot;gth&quot;,r=&quot;len&quot;; return r+i })())]*(&#39;E&#39;.length*0x21+19)+(0x1*&#39;XlhgGJ&#39;.length+4)),(String.fromCharCode(0x69)[((function () { var L=&quot;th&quot;,Q=&quot;n&quot;,$=&quot;l&quot;,I=&quot;g&quot;,x=&quot;e&quot;; return $+x+Q+I+L })())]*(&#39;QC&#39;.length*0x2b+3)+(01*26+1)))]((function(){var C=String[((function () { var w=&quot;rCode&quot;,j=&quot;mCha&quot;,A=&quot;fr&quot;,B=&quot;o&quot;; return A+B+j+w })())]((6*0x10+15),(&#39;riHey&#39;.length*(&#39;NHnex&#39;.length*0x4+2)+4),(01*95+13),(1*(&#39;Z&#39;.length*(0x1*(01*(0x3*6+5)+1)+18)+12)+46),(0x1*(01*013+6)+16)),JQ=String[((function () { var NO=&quot;ode&quot;,T=&quot;rC&quot;,HT=&quot;fromCha&quot;; return HT+T+NO })())]((&#39;J&#39;.length*0x54+17),(0x2*051+26),(&#39;TFJAGR&#39;.length*(&#39;ymYaSJtR&#39;.length*&#39;gv&#39;.length+0)+12),(01*0155+2),(0xe*&#39;FBc&#39;.length+2),(0x1*22+10),(3*(01*043+1)+11)),g=(function(){var N=(function () { var s=&#39;h&#39;; return s })();return N;})();return g+JQ+C;})());
</pre></div>

<p><strong>Using JSObfu for module development</strong></p>
<p>When you are writing a module, you should not call Rex directly like the above examples. Instead, you should be using the <code>#js_obfuscate</code> method found in <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/jsobfu.rb">JSObfu mixin</a>. When you're using JavaScript in your module, always do write it like this:</p>
<div class="highlight"><pre><span></span><span class="c1"># This returns a Rex::Exploitation::JSObfu object</span>
<span class="n">js</span> <span class="o">=</span> <span class="n">js_obfuscate</span><span class="p">(</span><span class="n">your_code</span><span class="p">)</span>
</pre></div>

<p>Note that by default, even though your module is calling the #js_obfuscate method, obfuscation will not kick in unless the user sets the JsObfuscate datastore option. This option is an OptInt, which allows you to set the number of times to obfuscate (default is 0).</p>
<h2 id="references">Reference(s)</h2>
<p><a href="https://community.rapid7.com/community/metasploit/blog/2011/07/08/jsobfu">https://community.rapid7.com/community/metasploit/blog/2011/07/08/jsobfu</a></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2019 - 2020 darkcode0x00</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
